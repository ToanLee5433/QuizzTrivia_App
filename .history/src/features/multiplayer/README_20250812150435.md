# Multiplayer Feature

Tính năng chơi multiplayer cho QuizTrivia App cho phép nhiều người chơi cùng tham gia một quiz.

## Cấu trúc thư mục

```
src/features/multiplayer/
├── components/
│   ├── MultiplayerLobby.tsx       # Lobby chờ trước khi bắt đầu game
│   ├── MultiplayerGameSimple.tsx  # Màn hình chơi game chính
│   ├── MultiplayerChat.tsx        # Chat trong phòng
│   ├── GameResults.tsx            # Kết quả cuối game
│   ├── RoomSettings.tsx           # Cài đặt phòng cho host
│   └── multiplayerStore.ts        # Redux store cho multiplayer
├── pages/
│   ├── MultiplayerMain.tsx        # Trang chính danh sách phòng
│   └── CreateMultiplayerRoom.tsx  # Trang tạo phòng mới
├── services/
│   └── firestoreMultiplayerService.ts # Service quản lý Firestore
├── types/
│   └── index.ts                   # Type definitions
└── index.ts                       # Export file
```

## Luồng hoạt động

1. **Trang chính** (`/multiplayer`):
   - Hiển thị danh sách phòng có sẵn
   - Cho phép tham gia bằng mã phòng
   - Nút tạo phòng mới

2. **Tạo phòng** (`/multiplayer/create`):
   - Chọn quiz từ danh sách
   - Cài đặt phòng (số người, thời gian, v.v.)
   - Tạo phòng và chuyển đến lobby

3. **Lobby** (`/multiplayer/lobby/:roomId`):
   - Hiển thị thông tin phòng và người chơi
   - Host có thể bắt đầu game
   - Các người chơi chờ host bắt đầu

4. **Game** (`/multiplayer/game/:roomId`):
   - Hiển thị câu hỏi và đáp án
   - Real-time scoring
   - Tự động chuyển câu tiếp theo

5. **Kết quả**:
   - Bảng xếp hạng cuối game
   - Thống kê chi tiết cho từng người chơi

## Tính năng chính

### Real-time Synchronization
- Sử dụng Firestore listeners để đồng bộ real-time
- Tất cả người chơi thấy câu hỏi cùng lúc
- Điểm số cập nhật ngay lập tức

### Room Management
- Host có thể quản lý cài đặt phòng
- Kick người chơi
- Thay đổi cài đặt game

### Scoring System
- Điểm số dựa trên độ chính xác và tốc độ
- Công thức: `max(0, 300 - (30 - timeLeft) * 10)`
- Bonus điểm cho streak (chuỗi trả lời đúng)

### Question Types Support
- Multiple choice
- True/False
- Short answer
- Image questions
- Rich text questions

## Database Schema

### MultiplayerRoom Collection
```typescript
{
  id: string;
  hostId: string;
  quiz: {
    id: string;
    title: string;
    questions: Question[];
  };
  players: Player[];
  settings: RoomSettings;
  status: 'waiting' | 'in-progress' | 'finished';
  currentQuestion?: number;
  questionAnswers?: {
    [questionIndex: number]: {
      [playerId: string]: AnswerData;
    };
  };
  createdAt: number;
  phase?: 'waiting' | 'question' | 'results' | 'finished';
}
```

## Usage Examples

### Tạo phòng mới
```typescript
const roomId = await firestoreMultiplayerService.createRoom(
  hostId,
  hostName, 
  quizData,
  settings
);
```

### Tham gia phòng
```typescript
const room = await firestoreMultiplayerService.joinRoom(
  roomId,
  playerId,
  playerName,
  playerAvatar
);
```

### Gửi câu trả lời
```typescript
await firestoreMultiplayerService.submitAnswer(
  questionIndex,
  answer,
  timeToAnswer,
  pointsEarned
);
```

### Lắng nghe cập nhật phòng
```typescript
const unsubscribe = firestoreMultiplayerService.onRoomUpdate((room) => {
  // Handle room updates
  setRoom(room);
});
```

## Performance Optimizations

- Lazy loading cho tất cả components
- Memoized calculations cho leaderboard
- Debounced real-time updates
- Efficient Firestore queries với indexing

## Security Rules

Firestore security rules cần được cấu hình để:
- Chỉ cho phép host thay đổi room settings
- Người chơi chỉ có thể gửi answer cho chính mình
- Đọc dữ liệu room chỉ khi là thành viên

## Error Handling

- Reconnection logic khi mất kết nối
- Graceful fallback khi service không khả dụng
- User-friendly error messages
- Automatic retry cho failed operations

## Future Enhancements

- Voice chat integration
- Spectator mode
- Tournament brackets
- Power-ups và special abilities
- Mobile app support
- Analytics và insights
