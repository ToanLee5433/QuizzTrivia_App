var e=Object.defineProperty,t=(t,s,r)=>((t,s,r)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r)(t,"symbol"!=typeof s?s+"":s,r);import{d as s,a as r,r as a,j as l,W as i,o as n,a5 as o,R as d,q as c,m,h as u,w as x,z as h,n as g,C as p,u as b,g as y,X as f,a6 as v,G as j,s as w,_ as N,x as C,t as S,i as A,p as D,v as q,y as I,D as k,l as z}from"./index-D8X0wEz4.js";import{S as R,W as P,a as M,G as T}from"./GameModeSelector-koXSbonl.js";import{X as E}from"./x-DH6wYMdX.js";import{C as Q}from"./circle-alert-B42OMoZ3.js";import{T as _}from"./trophy-BdpQ7BI1.js";import{A as L}from"./award-em6FByTd.js";import{M as U}from"./message-square-CMtOZkta.js";import{S as F}from"./send-CAwxfUY-.js";
/**
 * @license lucide-react v0.536.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=s("copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]),$=s("log-out",[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]]),G=s("medal",[["path",{d:"M7.21 15 2.66 7.14a2 2 0 0 1 .13-2.2L4.4 2.8A2 2 0 0 1 6 2h12a2 2 0 0 1 1.6.8l1.6 2.14a2 2 0 0 1 .14 2.2L16.79 15",key:"143lza"}],["path",{d:"M11 12 5.12 2.2",key:"qhuxz6"}],["path",{d:"m13 12 5.88-9.8",key:"hbye0f"}],["path",{d:"M8 7h8",key:"i86dvs"}],["circle",{cx:"12",cy:"17",r:"5",key:"qbz8iq"}],["path",{d:"M12 18v-2h-.5",key:"fawc4q"}]]),W=({isOpen:e,onClose:t,onCreateRoom:s,selectedQuiz:d,loading:c=!1})=>{var m;const{t:u}=r(),[x,h]=a.useState(""),[g,p]=a.useState(4),[b,y]=a.useState(30),[f,v]=a.useState(!1),[j,w]=a.useState(""),[N,C]=a.useState(!0);return e?l.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:l.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto",children:[l.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[l.jsx("h2",{className:"text-xl font-bold text-gray-900",children:u("multiplayer.createRoom")}),l.jsx("button",{onClick:t,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:l.jsx(E,{className:"w-5 h-5"})})]}),l.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),!x.trim())return;const t={name:x.trim(),maxPlayers:g,isPrivate:f,password:f?j:void 0,settings:{timePerQuestion:b,showLeaderboard:N,allowLateJoin:!0}};s(t)},className:"p-6 space-y-6",children:[l.jsxs("div",{children:[l.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:u("multiplayer.roomName")}),l.jsx("input",{type:"text",value:x,onChange:e=>h(e.target.value),placeholder:u("multiplayer.enterRoomName"),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0,disabled:c})]}),l.jsxs("div",{children:[l.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[l.jsx(i,{className:"w-4 h-4 inline mr-2"}),u("multiplayer.maxPlayers")," (1-20)"]}),l.jsx("input",{type:"number",value:g,onChange:e=>{const t=parseInt(e.target.value);t>=1&&t<=20&&p(t)},min:"1",max:"20",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0,disabled:c})]}),l.jsxs("div",{children:[l.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[l.jsx(n,{className:"w-4 h-4 inline mr-2"}),u("multiplayer.timeLimit")," (giây, tối đa 1000)"]}),l.jsx("input",{type:"number",value:b,onChange:e=>{const t=parseInt(e.target.value);t>=5&&t<=1e3&&y(t)},min:"5",max:"1000",placeholder:"VD: 30",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0,disabled:c}),l.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Từ 5 đến 1000 giây cho mỗi câu hỏi"})]}),l.jsxs("div",{className:"space-y-4",children:[l.jsxs("h3",{className:"text-sm font-medium text-gray-700 flex items-center",children:[l.jsx(R,{className:"w-4 h-4 mr-2"}),u("multiplayer.roomSettings")]}),l.jsxs("div",{className:"flex items-center",children:[l.jsx("input",{type:"checkbox",id:"showLeaderboard",checked:N,onChange:e=>C(e.target.checked),className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500",disabled:c}),l.jsx("label",{htmlFor:"showLeaderboard",className:"ml-2 text-sm text-gray-700",children:u("multiplayer.showLeaderboard")})]}),l.jsxs("div",{className:"flex items-center",children:[l.jsx("input",{type:"checkbox",id:"isPrivate",checked:f,onChange:e=>v(e.target.checked),className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500",disabled:c}),l.jsxs("label",{htmlFor:"isPrivate",className:"ml-2 text-sm text-gray-700 flex items-center",children:[l.jsx(o,{className:"w-4 h-4 mr-1"}),u("multiplayer.private")]})]}),f&&l.jsxs("div",{children:[l.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:u("multiplayer.password")}),l.jsx("input",{type:"password",value:j,onChange:e=>w(e.target.value),placeholder:u("multiplayer.enterPassword"),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:f,disabled:c})]})]}),d&&l.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[l.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:u("quiz.selectedQuiz")}),l.jsxs("div",{className:"text-sm text-blue-800",children:[l.jsx("div",{className:"font-medium",children:d.title}),l.jsxs("div",{className:"text-blue-600",children:[(null==(m=d.questions)?void 0:m.length)||0," câu hỏi"]})]})]}),l.jsxs("div",{className:"flex gap-3 pt-4",children:[l.jsx("button",{type:"button",onClick:t,className:"flex-1 px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors",disabled:c,children:u("common.cancel")}),l.jsx("button",{type:"submit",className:"flex-1 px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors font-medium",disabled:c,children:u(c?"common.loading":"multiplayer.createRoom")})]})]})]})}):null},Y=({isOpen:e,onClose:t,onJoinRoom:s,loading:i=!1,error:n})=>{const{t:p}=r(),[b,y]=a.useState(""),[f,v]=a.useState(""),[j,w]=a.useState(!1),[N,C]=a.useState("code"),[S,A]=a.useState(!1),D=()=>{y(""),v(""),w(!1),C("code"),t()};return d.useEffect(()=>{if(!n)return;const e=n.toLowerCase();(e.includes("yêu cầu mật khẩu")||e.includes("password"))&&(C("password"),w(!0))},[n]),d.useEffect(()=>{(async()=>{const e=b.trim().toUpperCase();if("code"===N&&6===e.length&&!i&&!S)try{A(!0);const t=c(m(u,"multiplayer_rooms"),x("code","==",e),h(1)),s=await g(t);if(!s.empty){s.docs[0].data().isPrivate&&(w(!0),C("password"))}}catch(t){}finally{A(!1)}})()},[b,N,i,S]),e?l.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:l.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-md w-full",children:[l.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[l.jsx("h2",{className:"text-xl font-bold text-gray-900",children:p("multiplayer.joinRoom")}),l.jsx("button",{onClick:D,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:l.jsx(E,{className:"w-5 h-5"})})]}),l.jsxs("form",{onSubmit:e=>{if(e.preventDefault(),"code"===N){if(!b.trim())return;s(b.trim().toUpperCase())}else if("password"===N){if(!f.trim())return;s(b.trim().toUpperCase(),f.trim())}},className:"p-6 space-y-6",children:[l.jsxs("div",{children:[l.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:p("multiplayer.roomCode")}),l.jsx("input",{type:"text",value:b,onChange:e=>y(e.target.value.toUpperCase()),placeholder:p("multiplayer.enterRoomCode"),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-lg font-mono tracking-wider",maxLength:6,required:!0,disabled:i||"password"===N}),l.jsx("div",{className:"text-xs text-gray-500 mt-1 text-center",children:p("multiplayer.roomCodeHint")})]}),j&&l.jsxs("div",{children:[l.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[l.jsx(o,{className:"w-4 h-4 inline mr-2"}),p("multiplayer.password")]}),l.jsx("input",{type:"password",value:f,onChange:e=>v(e.target.value),placeholder:p("multiplayer.enterPassword"),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:"password"===N,disabled:i})]}),n&&"Phòng này yêu cầu mật khẩu"!==n&&l.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-lg",children:[l.jsx(Q,{className:"w-5 h-5 text-red-600 flex-shrink-0"}),l.jsx("span",{className:"text-red-700 text-sm",children:n})]}),"password"===N&&l.jsxs("div",{className:"flex items-center gap-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:[l.jsx(o,{className:"w-5 h-5 text-yellow-600 flex-shrink-0"}),l.jsx("span",{className:"text-yellow-700 text-sm",children:p("multiplayer.passwordRequired")})]}),l.jsxs("div",{className:"flex gap-3 pt-4",children:[l.jsx("button",{type:"button",onClick:D,className:"flex-1 px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors",disabled:i,children:p("common.cancel")}),"password"===N&&l.jsx("button",{type:"button",onClick:()=>{C("code"),w(!1),v("")},className:"px-4 py-2 text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors",disabled:i,children:p("common.back")}),l.jsx("button",{type:"submit",className:"flex-1 px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors font-medium disabled:opacity-50",disabled:i||!b.trim()||"password"===N&&!f.trim(),children:i?l.jsxs("div",{className:"flex items-center justify-center gap-2",children:[l.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),p("common.loading")]}):p("code"===N?"multiplayer.joinRoom":"common.submit")})]})]})]})}):null},B=({roomData:e,currentUserId:t,onLeaveRoom:s,multiplayerService:o})=>{const{t:d}=r(),[c,m]=a.useState(!1),[u,x]=a.useState(null),h=(null==e?void 0:e.players)||[],g=a.useMemo(()=>h.filter(e=>e.isReady).length,[h]),b=a.useMemo(()=>h.length>=2&&h.every(e=>e.isReady),[h]),y=h.find(e=>e.id===t);a.useEffect(()=>{if(b&&h.length>=2){x(5);const t=setInterval(()=>{x(s=>null===s||s<=1?(clearInterval(t),o&&(null==e?void 0:e.id)&&o.startGame(e.id),null):s-1)},1e3);return()=>clearInterval(t)}x(null)},[b,h.length,o,null==e?void 0:e.id]);return e?l.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100 p-4 lg:p-6",children:l.jsxs("div",{className:"max-w-7xl mx-auto",children:[l.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-6 mb-6",children:[l.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-4",children:[l.jsxs("div",{children:[l.jsx("h2",{className:"text-2xl sm:text-3xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent",children:e.name}),l.jsxs("div",{className:"flex flex-wrap items-center gap-4 mt-3",children:[l.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[l.jsx(i,{size:18,className:"text-blue-500"}),l.jsx("span",{className:"font-semibold",children:h.length}),l.jsxs("span",{className:"text-sm",children:["/",e.maxPlayers," ",d("multiplayer.players")]})]}),l.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[l.jsx(p,{size:18,className:"text-green-500"}),l.jsx("span",{className:"font-semibold",children:g}),l.jsx("span",{className:"text-sm",children:d("multiplayer.ready")})]}),l.jsxs("button",{onClick:async()=>{if(null==e?void 0:e.code)try{await navigator.clipboard.writeText(e.code),m(!0),setTimeout(()=>m(!1),2e3)}catch(t){}},className:"inline-flex items-center gap-2 px-3 py-2 rounded-lg font-medium transition-all "+(c?"bg-green-100 text-green-700 border border-green-200":"bg-blue-100 text-blue-700 border border-blue-200 hover:bg-blue-200"),children:[l.jsx(O,{size:16}),l.jsx("span",{className:"font-mono text-lg",children:e.code}),c&&l.jsx("span",{className:"text-xs",children:"Copied!"})]})]})]}),l.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-3",children:[u&&l.jsxs("div",{className:"flex items-center justify-center gap-2 bg-orange-100 text-orange-700 px-4 py-2 rounded-xl font-bold",children:[l.jsx(n,{size:18}),l.jsxs("span",{children:[d("multiplayer.startingIn")," ",u,"s"]})]}),l.jsxs("div",{className:"flex gap-2",children:[l.jsxs("button",{onClick:s,className:"px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl border border-gray-300 transition-colors flex items-center gap-2",children:[l.jsx($,{size:16}),d("multiplayer.leaveRoom")]}),l.jsxs("button",{onClick:async()=>{if(!o||!(null==e?void 0:e.id))return;const t=!(null==y?void 0:y.isReady);await o.updatePlayerStatus(e.id,t)},className:"px-6 py-3 rounded-xl font-semibold transition-all transform hover:scale-105 flex items-center gap-2 shadow-lg "+((null==y?void 0:y.isReady)?"bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white":"bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white"),children:[l.jsx(p,{size:18}),(null==y?void 0:y.isReady)?d("multiplayer.notReady"):d("multiplayer.ready")]})]})]})]}),l.jsxs("div",{className:"grid grid-cols-3 gap-4 mt-6",children:[l.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-4 text-center",children:[l.jsx("div",{className:"text-2xl font-bold text-blue-600",children:h.length}),l.jsx("div",{className:"text-sm text-blue-700",children:d("multiplayer.totalPlayers")})]}),l.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-4 text-center",children:[l.jsx("div",{className:"text-2xl font-bold text-green-600",children:g}),l.jsx("div",{className:"text-sm text-green-700",children:d("multiplayer.readyPlayers")})]}),l.jsxs("div",{className:"bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-4 text-center",children:[l.jsxs("div",{className:"text-2xl font-bold text-purple-600",children:[e.settings.timeLimit,"s"]}),l.jsx("div",{className:"text-sm text-purple-700",children:d("multiplayer.timePerQuestion")})]})]})]}),l.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:[h.map(e=>l.jsxs("div",{className:"bg-white rounded-2xl p-6 shadow-lg border-2 transition-all duration-200 "+(e.id===t?"border-blue-400 bg-gradient-to-br from-blue-50 to-indigo-50":"border-gray-200 hover:border-gray-300"),children:[l.jsx("div",{className:"flex items-center justify-between mb-4",children:l.jsxs("div",{className:"flex items-center gap-4",children:[l.jsx("div",{className:"relative w-14 h-14 rounded-2xl flex items-center justify-center text-white font-bold text-lg bg-gradient-to-br from-blue-500 to-purple-600",children:e.username.charAt(0).toUpperCase()}),l.jsxs("div",{className:"min-w-0 flex-1",children:[l.jsxs("div",{className:"font-bold text-gray-800 text-lg flex items-center gap-2",children:[l.jsx("span",{className:"truncate",children:e.username}),e.id===t&&l.jsx("span",{className:"text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full shrink-0",children:d("common.you")})]}),l.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[l.jsx("div",{className:"w-2 h-2 rounded-full bg-green-400"}),l.jsx("span",{className:"text-sm text-gray-600",children:"Hoạt động"})]})]})]})}),l.jsx("div",{className:"flex items-center justify-center",children:l.jsx("div",{className:"flex items-center gap-2 px-3 py-2 rounded-xl font-medium w-full justify-center "+(e.isReady?"bg-green-100 text-green-700 border border-green-200":"bg-gray-100 text-gray-600 border border-gray-200"),children:e.isReady?l.jsxs(l.Fragment,{children:[l.jsx(p,{size:16}),l.jsx("span",{children:d("multiplayer.ready")})]}):l.jsxs(l.Fragment,{children:[l.jsx(n,{size:16}),l.jsx("span",{children:d("multiplayer.waiting")})]})})})]},e.id)),Array.from({length:Math.max(0,e.maxPlayers-h.length)}).map((e,t)=>l.jsx("div",{className:"bg-gray-50 border-2 border-dashed border-gray-300 rounded-2xl p-6 flex items-center justify-center text-gray-400 min-h-[120px]",children:l.jsxs("div",{className:"text-center",children:[l.jsx(i,{size:24,className:"mx-auto mb-2 opacity-50"}),l.jsx("div",{className:"text-sm font-medium",children:d("multiplayer.waitingForPlayer")})]})},`empty-${t}`))]})]})}):l.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:l.jsxs("div",{className:"text-center",children:[l.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600 mx-auto"}),l.jsx("p",{className:"mt-4 text-gray-600",children:d("common.loading")})]})})},H=({gameData:e,roomData:t,currentUserName:s,multiplayerService:r})=>{var o,d,c,m;const[u,x]=a.useState(null),[h,g]=a.useState(!1),[j,w]=a.useState(!1),[N,C]=a.useState(null),[S,A]=a.useState(null),[D,q]=a.useState(null),[I,k]=a.useState(0),[z,R]=a.useState(e),[P,M]=a.useState(t),[T,E]=a.useState({}),[_,L]=a.useState({}),[U,F]=a.useState(!1),O=a.useRef(null),$=a.useRef(null),G=a.useRef(null),W=a.useRef(-1),Y=z||e,B=a.useMemo(()=>{const e={...t||{},...P||{}};return e.players=(null==t?void 0:t.players)||(null==P?void 0:P.players)||[],e},[t,P]),H=(null==Y?void 0:Y.timePerQuestion)??(null==(o=null==B?void 0:B.settings)?void 0:o.timePerQuestion)??30,[J,V]=a.useState(H),K=b(e=>e.auth.user),X=(null==Y?void 0:Y.phase)||"question",Z=(null==B?void 0:B.status)||"waiting",ee=e=>{if(!e)return null;if(e instanceof Date)return e;if("number"==typeof(null==e?void 0:e.seconds))return new Date(1e3*e.seconds);const t=new Date(e);return isNaN(t.getTime())?null:t};a.useEffect(()=>{if(!(null==t?void 0:t.id))return;const e=y(f,"multiplayer_rooms",t.id),s=v(e,e=>{var t,s,r,a,l,i,n;if(e.exists()){const o={id:e.id,...e.data()};if(M(o),o.gameData&&R(o.gameData),"starting"===o.status)if(o.gameStartAt&&o.gameStartDelay){const e=new Date(1e3*o.gameStartAt.seconds),t=new Date,s=Math.floor((t.getTime()-e.getTime())/1e3),r=Math.max(0,Math.floor(o.gameStartDelay/1e3)-s);q(r>0?r:0)}else q(5);if(("playing"===o.status&&"question"===(null==(t=o.gameData)?void 0:t.phase)||"starting"===o.status&&0===D)&&q(null),(null==(s=o.gameData)?void 0:s.questionEndAt)&&"question"===(null==(r=o.gameData)?void 0:r.phase)){const e=ee(o.gameData.questionEndAt);if(e){const t=new Date,s=Math.max(0,Math.ceil((e.getTime()-t.getTime())/1e3));s>0&&(k(s),V(s))}}const d=(null==(a=o.gameData)?void 0:a.currentQuestionIndex)??0;if(d!==W.current&&(W.current=d,x(null),g(!1),w(!1),C(null),V(H),F(!1),O.current&&(window.clearTimeout(O.current),O.current=null),$.current&&(window.clearTimeout($.current),$.current=null)),"results"===(null==(l=o.gameData)?void 0:l.phase)&&(null==(i=o.gameData)?void 0:i.nextQuestionAt)){const e=ee(o.gameData.nextQuestionAt);if(e){const t=new Date,s=Math.max(0,Math.ceil((e.getTime()-t.getTime())/1e3));s>=0&&(w(!0),A(s))}}"finished"===(null==(n=o.gameData)?void 0:n.phase)&&(w(!0),A(null))}});return()=>{s(),O.current&&(window.clearTimeout(O.current),O.current=null),$.current&&(window.clearTimeout($.current),$.current=null),G.current&&(window.clearTimeout(G.current),G.current=null)}},[null==t?void 0:t.id]),a.useEffect(()=>{if(Array.isArray(null==B?void 0:B.players)){const e={},t={};return B.players.forEach(s=>{const r=Array.isArray(s.answers)?s.answers:[];t[s.id]=r.map(e=>({questionId:e.questionId,selectedAnswer:e.selectedAnswer,isCorrect:!!e.isCorrect,timeSpent:e.timeSpent,points:e.points||0})),e[s.id]=r.reduce((e,t)=>e+(Number(t.points)||0),0)}),E(e),void L(t)}if(B&&B.questionAnswers){const e={},t={},s=B.questionAnswers;Object.values(s).forEach(s=>{Object.entries(s).forEach(([s,r])=>{e[s]=(e[s]||0)+(r.pointsEarned||0),t[s]||(t[s]=[]),t[s].push({questionId:r.questionId,selectedAnswer:r.selectedAnswer,isCorrect:r.isCorrect,timeSpent:r.timeToAnswer||r.timeSpent,points:r.pointsEarned||0})})}),E(e),L(t)}},[null==B?void 0:B.players,null==B?void 0:B.questionAnswers]),a.useEffect(()=>(null!==D&&D>0?G.current=window.setTimeout(()=>{q(e=>(e??0)-1)},1e3):0===D&&q(null),()=>{G.current&&(window.clearTimeout(G.current),G.current=null)}),[D]),a.useEffect(()=>{if(null!==I&&I>0&&"question"===(null==z?void 0:z.phase)){const e=window.setTimeout(()=>{k(e=>(e??0)-1)},1e3);return()=>window.clearTimeout(e)}},[I,null==z?void 0:z.phase]);const te=(null==z?void 0:z.phase)||X,se=(null==P?void 0:P.status)||Z;a.useEffect(()=>{"playing"===se&&"question"===te&&q(null)},[se,te]),a.useEffect(()=>{(async()=>{"finished"===te&&(null==K?void 0:K.uid)&&(null==B||B.id)})()},[te,null==K?void 0:K.uid,null==B?void 0:B.id]);const re=a.useMemo(()=>((null==Y?void 0:Y.questions)||[]).map(e=>{let t=[],s=0;return e.answers&&Array.isArray(e.answers)?(t=e.answers.map(e=>e.text),s=e.answers.findIndex(e=>e.isCorrect),-1===s&&(s=0)):e.options&&Array.isArray(e.options)&&(t=e.options,s=0),{id:e.id,title:e.text||e.title||"No question text",options:t,correct:s,type:e.type,points:e.points,explanation:`Correct answer: ${t[s]||"N/A"}`}}),[null==Y?void 0:Y.questions]),ae=(null==Y?void 0:Y.currentQuestionIndex)||0,le=re[ae]||{id:"error",title:"No question available",options:["Please wait..."],correct:0,explanation:"Question loading..."};a.useEffect(()=>{if(!(h||j||J<=0))return O.current=window.setTimeout(()=>{V(e=>e-1)},1e3),()=>{O.current&&(window.clearTimeout(O.current),O.current=null)}},[J,h,j]),a.useEffect(()=>{J<=0&&!h&&ie(u??void 0)},[J,h]),a.useEffect(()=>{if(!(null===S||S<=0))return $.current=window.setTimeout(()=>{A(e=>null!==e?e-1:null)},1e3),()=>{$.current&&(window.clearTimeout($.current),$.current=null)}},[S]);const ie=async e=>{const t=void 0!==e?e:u;if(!h)if(g(!0),r&&(null==B?void 0:B.id)&&(null==le?void 0:le.id)&&(null==K?void 0:K.uid))try{const e=H-J,s=null!==t&&t===le.correct,a=s?Math.max(10,Math.floor(100-2*e)):0;E(e=>({...e,[K.uid]:(e[K.uid]||0)+a})),L(r=>({...r,[K.uid]:[...r[K.uid]||[],{questionId:le.id,selectedAnswer:t??-1,isCorrect:s,timeSpent:e,points:a}]})),null!==t&&await r.submitAnswer(B.id,le.id,t,e),F(!0),setTimeout(()=>{C({isCorrect:s,correctAnswer:le.correct,selectedAnswer:t??-1,points:a,explanation:le.explanation||""}),w(!0)},1e3)}catch(s){g(!1)}else g(!1)},ne=a.useMemo(()=>Math.max(0,Math.min(100,Math.round(J/H*100))),[J,H]),oe=2*Math.PI*16,de=oe-ne/100*oe;return l.jsx("div",{className:"min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-blue-100 p-2 sm:p-4 lg:p-6",children:l.jsxs("div",{className:"max-w-4xl mx-auto",children:["starting"===se&&null!==D&&D>=0&&l.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-8 text-center mb-6",children:[l.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-4",children:"Game Starting Soon!"}),l.jsx("div",{className:"text-6xl font-bold text-purple-600 mb-4",children:D}),l.jsx("p",{className:"text-gray-600",children:"Get ready to answer questions!"})]}),"results"===te&&N&&l.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-6 mb-6",children:[l.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-4 text-center",children:"Question Results"}),l.jsx("div",{className:"mb-6 p-4 bg-blue-50 rounded-xl border border-blue-200",children:l.jsxs("div",{className:"text-center",children:[l.jsx("div",{className:"text-2xl font-bold mb-2 "+(N.isCorrect?"text-green-600":"text-red-600"),children:N.isCorrect?"✅ Correct!":"❌ Wrong!"}),l.jsxs("div",{className:"text-lg text-gray-700 mb-2",children:["You earned ",l.jsxs("span",{className:"font-bold text-blue-600",children:["+",N.points]})," points"]}),l.jsxs("div",{className:"text-sm text-gray-600",children:["Correct Answer: ",l.jsx("span",{className:"font-semibold",children:(null==(d=le.options)?void 0:d[N.correctAnswer])||"N/A"})]}),N.explanation&&l.jsx("p",{className:"text-xs text-gray-500 mt-2",children:N.explanation})]})}),l.jsxs("div",{className:"mb-6",children:[l.jsx("h4",{className:"font-semibold text-gray-700 mb-3 text-center",children:"Kết quả câu hỏi của tất cả người chơi"}),l.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:((null==B?void 0:B.players)||[]).map(e=>{const t=(Array.isArray(e.answers)?e.answers:[]).find(e=>(null==e?void 0:e.questionId)===le.id),s=e.id===(null==K?void 0:K.uid),r=!!(null==t?void 0:t.isCorrect),a=Number(null==t?void 0:t.points)||0,i="number"==typeof(null==t?void 0:t.selectedAnswer)?t.selectedAnswer:null,n=null!==i?["A","B","C","D","E","F"][i]??String(i+1):"-";return l.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg "+(s?"bg-blue-50":"bg-gray-50"),children:[l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx("span",{className:"text-lg "+(r?"text-green-600":"text-red-600"),children:r?"✓":"✗"}),l.jsxs("div",{className:"font-medium text-sm "+(s?"text-blue-700":"text-gray-800"),children:[(null==e?void 0:e.username)||(null==e?void 0:e.name)||"Player",s&&" (You)"]}),l.jsxs("div",{className:"text-xs text-gray-500",children:["Chọn: ",n]})]}),l.jsxs("div",{className:"text-sm font-semibold "+(r?"text-green-700":"text-gray-700"),children:["+",a," điểm"]})]},e.id)})})]}),l.jsxs("div",{className:"mb-4",children:[l.jsx("h4",{className:"font-semibold text-gray-700 mb-3 text-center",children:"Current Standings"}),l.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:((null==B?void 0:B.players)||[]).map(e=>{const t=(Array.isArray(e.answers)?e.answers:[]).reduce((e,t)=>e+(Number(t.points)||0),0);return{...e,score:"number"==typeof T[e.id]?T[e.id]:t}}).sort((e,t)=>t.score-e.score).map((e,t)=>{const r=e.id===(null==K?void 0:K.uid),a=t+1,i=1===a?"👑":2===a?"🥈":3===a?"🥉":"🏅",n=_[e.id]||(Array.isArray(e.answers)?e.answers.map(e=>({questionId:e.questionId,selectedAnswer:e.selectedAnswer,isCorrect:!!e.isCorrect,timeSpent:e.timeSpent,points:e.points||0})):[]),o=n.find(e=>e.questionId===le.id),d=n.filter(e=>e.isCorrect).length||0;return l.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg "+(r?"bg-blue-100 border border-blue-300":"bg-gray-50"),children:[l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsx("span",{className:"text-lg",children:i}),l.jsxs("div",{children:[l.jsxs("div",{className:"font-medium text-sm "+(r?"text-blue-700":"text-gray-800"),children:["#",a," ",r?s||(null==e?void 0:e.username)||(null==e?void 0:e.name)||"You":(null==e?void 0:e.username)||(null==e?void 0:e.name)||(null==e?void 0:e.displayName)||`Player ${a}`,r&&l.jsx("span",{className:"ml-1 text-xs",children:"(You)"})]}),l.jsxs("div",{className:"text-xs text-gray-500",children:[d," đúng • ",e.score," điểm",o&&l.jsxs("span",{className:"ml-2 "+(o.isCorrect?"text-green-600":"text-red-600"),children:[o.isCorrect?"✓":"✗"," +",o.points]})]})]})]}),l.jsxs("div",{className:"text-right "+(r?"text-blue-700":"text-gray-700"),children:[l.jsx("div",{className:"font-bold text-sm",children:e.score}),l.jsx("div",{className:"text-xs text-gray-500",children:"pts"})]})]},e.id)})})]}),null!==S&&l.jsx("div",{className:"mt-4 text-center",children:S>0?l.jsxs("p",{className:"text-gray-600",children:["Câu hỏi tiếp theo trong: ",l.jsxs("span",{className:"font-bold text-blue-600",children:[S,"s"]})]}):l.jsx("p",{className:"text-gray-600",children:"Đang chờ người chơi khác..."})})]}),"finished"===te&&l.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 p-4",children:l.jsxs("div",{className:"max-w-4xl mx-auto",children:[l.jsxs("div",{className:"text-center mb-8",children:[l.jsx("div",{className:"inline-flex items-center justify-center w-24 h-24 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full mb-4 shadow-2xl",children:l.jsx("span",{className:"text-4xl",children:"🏆"})}),l.jsx("h1",{className:"text-5xl font-black text-white mb-2 bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent",children:"GAME COMPLETE!"}),l.jsx("p",{className:"text-xl text-blue-200",children:"Amazing performance by all players"})]}),l.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8",children:Object.entries(T).sort(([,e],[,t])=>t-e).slice(0,3).map(([e,t],s)=>{var r;const a=null==(r=null==B?void 0:B.players)?void 0:r.find(t=>t.id===e),i=e===(null==K?void 0:K.uid),n=s+1,o=(_[e]||[]).filter(e=>e.isCorrect).length,d=re.length,c=d>0?Math.round(o/d*100):0,m={1:{trophy:"🥇",color:"from-yellow-400 to-yellow-600",bgColor:"from-yellow-50 to-orange-50",borderColor:"border-yellow-400",height:"h-32"},2:{trophy:"🥈",color:"from-gray-400 to-gray-600",bgColor:"from-gray-50 to-slate-50",borderColor:"border-gray-400",height:"h-24"},3:{trophy:"🥉",color:"from-amber-600 to-amber-800",bgColor:"from-amber-50 to-yellow-50",borderColor:"border-amber-500",height:"h-20"}}[n];return l.jsx("div",{className:"text-center",children:l.jsxs("div",{className:`bg-white rounded-2xl shadow-2xl border-4 ${m.borderColor} overflow-hidden transform hover:scale-105 transition-all duration-300 ${i?"ring-4 ring-blue-400":""}`,children:[l.jsx("div",{className:`bg-gradient-to-r ${m.color} ${m.height} flex items-end justify-center pb-4`,children:l.jsx("span",{className:"text-6xl",children:m.trophy})}),l.jsxs("div",{className:`bg-gradient-to-r ${m.bgColor} p-6`,children:[l.jsxs("div",{className:"text-2xl font-bold text-gray-800 mb-1",children:["#",n]}),l.jsxs("div",{className:"text-lg font-semibold mb-2 "+(i?"text-blue-700":"text-gray-700"),children:[(null==a?void 0:a.username)||(null==a?void 0:a.name)||"Player",i&&l.jsx("div",{className:"text-sm text-blue-600 font-medium",children:"(You)"})]}),l.jsxs("div",{className:"bg-white rounded-xl p-4 mb-3 shadow-inner",children:[l.jsx("div",{className:"text-3xl font-black text-gray-800",children:t}),l.jsx("div",{className:"text-sm text-gray-600 font-medium",children:"POINTS"})]}),l.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[l.jsxs("div",{className:"bg-white rounded-lg p-2",children:[l.jsx("div",{className:"font-bold text-green-600",children:o}),l.jsx("div",{className:"text-gray-600",children:"Correct"})]}),l.jsxs("div",{className:"bg-white rounded-lg p-2",children:[l.jsxs("div",{className:"font-bold text-blue-600",children:[c,"%"]}),l.jsx("div",{className:"text-gray-600",children:"Accuracy"})]})]})]})]})},e)})}),l.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl p-8 mb-8",children:[l.jsx("h2",{className:"text-3xl font-black text-gray-800 mb-6 text-center",children:"🏅 COMPLETE RANKINGS"}),l.jsx("div",{className:"space-y-3",children:Object.entries(T).sort(([,e],[,t])=>t-e).map(([e,t],s)=>{var r;const a=null==(r=null==B?void 0:B.players)?void 0:r.find(t=>t.id===e),i=e===(null==K?void 0:K.uid),n=s+1,o=_[e]||[],d=o.filter(e=>e.isCorrect).length,c=re.length,m=c>0?Math.round(d/c*100):0,u=o.length>0?Math.round(o.reduce((e,t)=>e+t.timeSpent,0)/o.length):0,x={1:"bg-gradient-to-r from-yellow-100 to-orange-100 border-yellow-400",2:"bg-gradient-to-r from-gray-100 to-slate-100 border-gray-400",3:"bg-gradient-to-r from-amber-100 to-yellow-100 border-amber-400"}[n]||(i?"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-400":"bg-white border-gray-200");return l.jsx("div",{className:`${x} border-2 rounded-2xl p-4 transform hover:scale-102 transition-all duration-200 shadow-lg hover:shadow-xl`,children:l.jsxs("div",{className:"flex items-center justify-between",children:[l.jsxs("div",{className:"flex items-center gap-4",children:[l.jsx("div",{className:"text-center",children:l.jsxs("div",{className:"w-12 h-12 rounded-full flex items-center justify-center font-black text-lg "+(n<=3?"bg-gradient-to-r from-purple-500 to-blue-600 text-white":"bg-gray-200 text-gray-700"),children:["#",n]})}),l.jsxs("div",{children:[l.jsxs("div",{className:"text-xl font-bold "+(i?"text-blue-700":"text-gray-800"),children:[(null==a?void 0:a.username)||(null==a?void 0:a.name)||"Player",i&&l.jsx("span",{className:"ml-2 text-sm bg-blue-500 text-white px-2 py-1 rounded-full",children:"YOU"})]}),l.jsxs("div",{className:"text-sm text-gray-600",children:[d,"/",c," correct • ",m,"% accuracy • Avg: ",u,"s"]})]})]}),l.jsxs("div",{className:"text-right",children:[l.jsx("div",{className:"text-3xl font-black "+(i?"text-blue-700":"text-gray-800"),children:t}),l.jsx("div",{className:"text-sm text-gray-600 font-medium",children:"POINTS"})]})]})},e)})})]}),l.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-8",children:[l.jsxs("div",{className:"bg-white rounded-2xl p-6 text-center shadow-xl",children:[l.jsx("div",{className:"text-3xl mb-2",children:"📝"}),l.jsx("div",{className:"text-2xl font-bold text-gray-800",children:re.length}),l.jsx("div",{className:"text-sm text-gray-600 font-medium",children:"Total Questions"})]}),l.jsxs("div",{className:"bg-white rounded-2xl p-6 text-center shadow-xl",children:[l.jsx("div",{className:"text-3xl mb-2",children:"👥"}),l.jsx("div",{className:"text-2xl font-bold text-gray-800",children:Object.keys(T).length}),l.jsx("div",{className:"text-sm text-gray-600 font-medium",children:"Players"})]}),l.jsxs("div",{className:"bg-white rounded-2xl p-6 text-center shadow-xl",children:[l.jsx("div",{className:"text-3xl mb-2",children:"✅"}),l.jsx("div",{className:"text-2xl font-bold text-gray-800",children:(null==(c=_[(null==K?void 0:K.uid)||""])?void 0:c.filter(e=>e.isCorrect).length)||0}),l.jsx("div",{className:"text-sm text-gray-600 font-medium",children:"Your Correct"})]}),l.jsxs("div",{className:"bg-white rounded-2xl p-6 text-center shadow-xl",children:[l.jsx("div",{className:"text-3xl mb-2",children:"🎯"}),l.jsx("div",{className:"text-2xl font-bold text-gray-800",children:T[(null==K?void 0:K.uid)||""]||0}),l.jsx("div",{className:"text-sm text-gray-600 font-medium",children:"Your Score"})]})]}),l.jsxs("div",{className:"text-center",children:[l.jsx("p",{className:"text-xl text-blue-200 mb-6",children:"Thanks for playing! 🎉"}),l.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-center",children:[l.jsx("button",{onClick:()=>window.location.href="/multiplayer",className:"bg-gradient-to-r from-purple-600 to-blue-600 text-white px-8 py-4 rounded-2xl font-bold text-lg hover:from-purple-700 hover:to-blue-700 transform hover:scale-105 transition-all duration-200 shadow-2xl hover:shadow-purple-500/25",children:"🎮 Play Again"}),l.jsx("button",{onClick:()=>window.location.href="/profile",className:"bg-gradient-to-r from-gray-600 to-gray-700 text-white px-8 py-4 rounded-2xl font-bold text-lg hover:from-gray-700 hover:to-gray-800 transform hover:scale-105 transition-all duration-200 shadow-2xl",children:"👤 View Profile"}),l.jsx("button",{onClick:()=>window.location.href="/leaderboard",className:"bg-gradient-to-r from-green-600 to-teal-600 text-white px-8 py-4 rounded-2xl font-bold text-lg hover:from-green-700 hover:to-teal-700 transform hover:scale-105 transition-all duration-200 shadow-2xl",children:"🏆 Global Leaderboard"})]})]})]})}),("playing"===se&&"question"===te||"starting"===se&&0===D)&&"finished"!==te&&re.length>0&&l.jsxs(l.Fragment,{children:[l.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-4 sm:mb-6",children:[l.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4",children:[l.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4",children:[l.jsxs("div",{className:"bg-gradient-to-r from-purple-500 to-blue-600 text-white px-3 sm:px-4 py-2 rounded-xl font-bold text-sm sm:text-base text-center",children:["Question ",ae+1," of ",re.length]}),l.jsxs("div",{className:"flex items-center gap-2 text-gray-600 justify-center sm:justify-start",children:[l.jsx(i,{size:18}),l.jsxs("span",{className:"text-sm sm:text-base",children:[(null==(m=null==B?void 0:B.players)?void 0:m.length)||0," players"]})]})]}),l.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-2 sm:gap-4",children:[h&&l.jsxs("div",{className:"flex items-center gap-2 bg-green-100 text-green-700 px-3 py-2 rounded-xl font-medium text-sm",children:[l.jsx(p,{size:16}),l.jsx("span",{children:"Submitted!"})]}),l.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[l.jsxs("div",{className:"flex items-center gap-2 px-3 sm:px-4 py-2 rounded-xl font-bold text-sm sm:text-base "+(J<=5?"bg-red-100 text-red-700":"bg-blue-100 text-blue-700"),children:[l.jsx(n,{size:16}),l.jsxs("span",{children:[J,"s"]})]}),l.jsxs("div",{className:"relative w-12 h-12 sm:w-16 sm:h-16",children:[l.jsxs("svg",{className:"w-12 h-12 sm:w-16 sm:h-16 transform -rotate-90",viewBox:"0 0 36 36",children:[l.jsx("circle",{cx:"18",cy:"18",r:"16",fill:"none",stroke:"#e5e7eb",strokeWidth:"3"}),l.jsx("circle",{cx:"18",cy:"18",r:"16",fill:"none",stroke:J<=5?"#ef4444":"#3b82f6",strokeWidth:"3",strokeLinecap:"round",strokeDasharray:oe,strokeDashoffset:de,className:"transition-all duration-1000"})]}),l.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:l.jsxs("span",{className:"text-xs font-bold "+(J<=5?"text-red-600":"text-blue-600"),children:[ne,"%"]})})]})]})]})]}),J<=10&&!h&&l.jsx("div",{className:"bg-orange-100 border-l-4 border-orange-500 p-4 rounded-r-lg mb-4",children:l.jsxs("div",{className:"flex items-center gap-2 text-orange-700",children:[l.jsx(Q,{size:18}),l.jsx("span",{className:"font-medium",children:"Time is running out!"})]})}),U&&l.jsx("div",{className:"bg-blue-100 border-l-4 border-blue-500 p-4 rounded-r-lg mb-4",children:l.jsxs("div",{className:"flex items-center gap-2 text-blue-700",children:[l.jsx(n,{size:18}),l.jsx("span",{className:"font-medium",children:"Waiting for other players..."})]})})]}),l.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8",children:[l.jsxs("div",{className:"text-center mb-6 sm:mb-8",children:[l.jsx("h2",{className:"text-lg sm:text-xl lg:text-2xl font-bold text-gray-800 mb-4",children:le.title||"No question available"}),l.jsx("div",{className:"w-12 sm:w-16 h-1 bg-gradient-to-r from-purple-500 to-blue-600 mx-auto rounded-full"})]}),(!le.options||0===le.options.length)&&l.jsxs("div",{className:"text-center p-8 bg-gray-50 rounded-xl",children:[l.jsx("p",{className:"text-gray-600",children:"Waiting for question options to load..."}),l.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:["Questions available: ",re.length," | Current index: ",ae]})]}),le.options&&le.options.length>0?l.jsx("div",{className:"grid gap-3 sm:gap-4 mb-6 sm:mb-8",children:le.options.map((e,t)=>{const s=u===t;return l.jsx("button",{onClick:()=>{return e=t,void(h||(x(e),setTimeout(()=>ie(e),100)));var e},className:`group relative px-4 sm:px-6 py-3 sm:py-4 rounded-2xl text-left transition-all duration-200 transform hover:scale-105 ${s?"border-2 border-blue-500 bg-gradient-to-r from-blue-50 to-indigo-50 shadow-lg":"border-2 border-gray-200 bg-white hover:border-gray-300 hover:shadow-md"} ${h?"opacity-60 cursor-not-allowed transform-none":""}`,disabled:h,children:l.jsxs("div",{className:"flex items-center gap-3 sm:gap-4",children:[l.jsx("div",{className:"w-8 h-8 sm:w-10 sm:h-10 rounded-xl flex items-center justify-center font-bold text-xs sm:text-sm "+(s?"bg-blue-500 text-white":"bg-gray-100 text-gray-600 group-hover:bg-gray-200"),children:["A","B","C","D"][t]||t+1}),l.jsx("span",{className:"font-medium text-gray-800 text-sm sm:text-base",children:e})]})},t)})}):l.jsx("div",{className:"bg-red-100 p-4 rounded-lg",children:l.jsx("p",{className:"text-red-700",children:"❌ No options available for this question"})}),l.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[l.jsx("div",{className:"text-sm text-gray-500 text-center sm:text-left",children:h?"Answer submitted":null!==u?"Answer selected":"Choose your answer"}),h&&l.jsxs("div",{className:"flex items-center gap-2 bg-green-100 text-green-700 px-4 py-2 rounded-xl font-medium",children:[l.jsx(p,{size:16}),l.jsx("span",{children:"Submitted!"})]})]})]}),j&&N&&l.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:l.jsx("div",{className:"bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6 transform animate-in fade-in zoom-in-95 duration-300",children:l.jsxs("div",{className:"text-center mb-6",children:[l.jsx("div",{className:"w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-4 "+(N.isCorrect?"bg-green-100 text-green-600":"bg-red-100 text-red-600"),children:N.isCorrect?l.jsx(p,{size:40}):l.jsx(Q,{size:40})}),l.jsx("h3",{className:"text-2xl font-bold mb-2 "+(N.isCorrect?"text-green-600":"text-red-600"),children:N.isCorrect?"🎉 Correct!":"❌ Incorrect"}),l.jsxs("div",{className:"text-3xl font-bold text-blue-600 mb-4",children:["+",N.points," points"]}),l.jsx("p",{className:"text-gray-600 mb-4",children:N.explanation}),null!==S&&l.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-xl p-4",children:l.jsxs("div",{className:"flex items-center justify-center gap-2 text-blue-700",children:[l.jsx(n,{size:20}),l.jsx("span",{className:"font-semibold",children:S>0?`Câu hỏi tiếp theo trong ${S} giây...`:"Đang chờ người chơi khác..."})]})})]})})})]})]})})},J=({players:e=[],currentUserId:t="",gameStats:s={totalQuestions:0,totalTime:0,averageScore:0},onPlayAgain:a,onBackToLobby:o,onLeaveRoom:d})=>{const{t:c}=r(),m=e=>{switch(e){case 1:return l.jsx(_,{className:"w-6 h-6 text-yellow-500"});case 2:return l.jsx(G,{className:"w-6 h-6 text-gray-400"});case 3:return l.jsx(L,{className:"w-6 h-6 text-orange-500"});default:return l.jsxs("div",{className:"w-6 h-6 flex items-center justify-center text-gray-500 font-bold",children:["#",e]})}},u=e=>{switch(e){case 1:return"bg-gradient-to-r from-yellow-100 to-yellow-200 border-yellow-300";case 2:return"bg-gradient-to-r from-gray-100 to-gray-200 border-gray-300";case 3:return"bg-gradient-to-r from-orange-100 to-orange-200 border-orange-300";default:return"bg-gray-50 border-gray-200"}},x=e.find(e=>e.id===t),h=[...e].sort((e,t)=>t.score-e.score);return l.jsxs("div",{className:"max-w-4xl mx-auto p-4 space-y-6",children:[l.jsxs("div",{className:"text-center space-y-4",children:[l.jsxs("div",{className:"flex items-center justify-center gap-3",children:[l.jsx(_,{className:"w-8 h-8 text-yellow-500"}),l.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:c("multiplayer.game.gameOver")})]}),x&&l.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 inline-block",children:[l.jsx("div",{className:"text-lg font-semibold text-blue-900",children:c("multiplayer.yourResult")}),l.jsxs("div",{className:"flex items-center justify-center gap-6 mt-2 text-blue-800",children:[l.jsxs("div",{className:"text-center",children:[l.jsx("div",{className:"text-2xl font-bold",children:x.score}),l.jsx("div",{className:"text-sm",children:c("common.points")})]}),l.jsxs("div",{className:"text-center",children:[l.jsxs("div",{className:"text-2xl font-bold",children:["#",x.rank]}),l.jsx("div",{className:"text-sm",children:c("common.rank")})]}),l.jsxs("div",{className:"text-center",children:[l.jsxs("div",{className:"text-2xl font-bold",children:[Math.round(x.correctAnswers/x.totalAnswers*100),"%"]}),l.jsx("div",{className:"text-sm",children:c("common.accuracy")})]})]})]})]}),l.jsxs("div",{className:"bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden",children:[l.jsx("div",{className:"bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4",children:l.jsxs("h2",{className:"text-xl font-bold flex items-center gap-2",children:[l.jsx(_,{className:"w-6 h-6"}),c("multiplayer.game.finalResults")]})}),l.jsx("div",{className:"divide-y divide-gray-200",children:h.map((e,s)=>l.jsxs("div",{className:`p-4 flex items-center gap-4 ${u(s+1)} ${e.id===t?"ring-2 ring-blue-500":""}`,children:[l.jsx("div",{className:"flex items-center justify-center w-12",children:m(s+1)}),l.jsxs("div",{className:"flex-1",children:[l.jsxs("div",{className:"font-semibold text-gray-900 flex items-center gap-2",children:[e.username,e.id===t&&l.jsx("span",{className:"text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full",children:c("common.you")})]}),l.jsxs("div",{className:"text-sm text-gray-600",children:[e.correctAnswers,"/",e.totalAnswers," ",c("common.correct")," •",Math.round(e.averageTime),"s ",c("common.avgTime")]})]}),l.jsxs("div",{className:"text-right",children:[l.jsx("div",{className:"text-xl font-bold text-gray-900",children:e.score}),l.jsx("div",{className:"text-xs text-gray-500",children:c("common.points")})]}),l.jsxs("div",{className:"text-right w-16",children:[l.jsxs("div",{className:"text-lg font-semibold text-gray-700",children:[Math.round(e.correctAnswers/e.totalAnswers*100),"%"]}),l.jsx("div",{className:"text-xs text-gray-500",children:c("common.accuracy")})]})]},e.id))})]}),l.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[l.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-4 text-center",children:[l.jsx(j,{className:"w-8 h-8 text-blue-600 mx-auto mb-2"}),l.jsx("div",{className:"text-2xl font-bold text-gray-900",children:s.totalQuestions}),l.jsx("div",{className:"text-sm text-gray-600",children:c("multiplayer.totalQuestions")})]}),l.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-4 text-center",children:[l.jsx(n,{className:"w-8 h-8 text-green-600 mx-auto mb-2"}),l.jsxs("div",{className:"text-2xl font-bold text-gray-900",children:[Math.round(s.totalTime/60),"m"]}),l.jsx("div",{className:"text-sm text-gray-600",children:c("multiplayer.totalTime")})]}),l.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-4 text-center",children:[l.jsx(i,{className:"w-8 h-8 text-purple-600 mx-auto mb-2"}),l.jsx("div",{className:"text-2xl font-bold text-gray-900",children:Math.round(s.averageScore)}),l.jsx("div",{className:"text-sm text-gray-600",children:c("multiplayer.avgScore")})]})]}),l.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 justify-center",children:[a&&l.jsx("button",{onClick:a,className:"px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium",children:c("multiplayer.playAgain")}),o&&l.jsx("button",{onClick:o,className:"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium",children:c("multiplayer.backToLobby")}),d&&l.jsx("button",{onClick:d,className:"px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium",children:c("multiplayer.leaveRoom")})]})]})},V=({messages:e,onSendMessage:t,currentUserId:s,disabled:i=!1})=>{const{t:n}=r(),[o,d]=a.useState(""),c=a.useRef(null),m=a.useRef(null);a.useEffect(()=>{var e;null==(e=c.current)||e.scrollIntoView({behavior:"smooth"})},[e]);return l.jsxs("div",{className:"flex flex-col h-full bg-white border border-gray-200 rounded-lg",children:[l.jsxs("div",{className:"flex items-center gap-2 p-3 border-b border-gray-200 bg-gray-50 rounded-t-lg",children:[l.jsx(U,{className:"w-5 h-5 text-blue-600"}),l.jsx("h3",{className:"font-medium text-gray-900",children:n("multiplayer.chat.title")}),l.jsx("div",{className:"ml-auto",children:l.jsxs("span",{className:"text-xs text-gray-500",children:[e.length," ",n("common.messages")]})})]}),l.jsxs("div",{className:"flex-1 overflow-y-auto p-3 space-y-2 max-h-64",children:[0===e.length?l.jsx("div",{className:"text-center text-gray-500 text-sm py-8",children:n("multiplayer.chat.noMessages")}):e.map(e=>{return l.jsx("div",{className:"flex flex-col "+("system"===e.type?"items-center":e.userId===s?"items-end":"items-start"),children:"system"===e.type?l.jsx("div",{className:"bg-gray-100 text-gray-600 text-xs px-3 py-1 rounded-full",children:e.message}):l.jsxs("div",{className:"max-w-xs lg:max-w-md px-3 py-2 rounded-lg text-sm "+(e.userId===s?"bg-blue-600 text-white":"bg-gray-100 text-gray-900"),children:[e.userId!==s&&l.jsx("div",{className:"text-xs opacity-75 mb-1 font-medium",children:e.username}),l.jsx("div",{children:e.message}),l.jsx("div",{className:"text-xs mt-1 "+(e.userId===s?"text-blue-200":"text-gray-500"),children:(t=e.timestamp,new Intl.DateTimeFormat("vi-VN",{hour:"2-digit",minute:"2-digit"}).format(t))})]})},e.id);var t}),l.jsx("div",{ref:c})]}),l.jsxs("form",{onSubmit:e=>{var s;e.preventDefault(),o.trim()&&!i&&(t(o.trim()),d(""),null==(s=m.current)||s.focus())},className:"p-3 border-t border-gray-200",children:[l.jsxs("div",{className:"flex gap-2",children:[l.jsx("input",{ref:m,type:"text",value:o,onChange:e=>d(e.target.value),placeholder:n(i?"multiplayer.chat.disabled":"multiplayer.chat.placeholder"),className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm disabled:bg-gray-100 disabled:text-gray-500",disabled:i,maxLength:200}),l.jsx("button",{type:"submit",disabled:!o.trim()||i,className:"px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:l.jsx(F,{className:"w-4 h-4"})})]}),o.length>150&&l.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-right",children:[o.length,"/200"]})]})]})};class K{constructor(){t(this,"events",{})}on(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}off(e,t){this.events[e]&&(this.events[e]=this.events[e].filter(e=>e!==t))}emit(e,...t){this.events[e]&&this.events[e].forEach(e=>e(...t))}}class X extends K{constructor(){super(...arguments),t(this,"userId",""),t(this,"username",""),t(this,"currentRoomId",null),t(this,"unsubscribeFunctions",[])}async connect(e,t){this.userId=e,this.username=t,this.emit("connected",{userId:e,username:t})}async disconnect(){this.unsubscribeFunctions.forEach(e=>e()),this.unsubscribeFunctions=[],this.currentRoomId&&await this.leaveRoom(this.currentRoomId),this.emit("disconnected")}async createRoom(e,t){var s,r,a;try{const l=this.generateRoomCode(),i=y(m(u,"multiplayer_rooms")),n={id:this.userId,username:this.username,isReady:!1,score:0,answers:[],joinedAt:new Date},o={code:l,name:e.name||`${this.username}'s Room`,maxPlayers:e.maxPlayers||4,isPrivate:e.isPrivate||!1,password:e.password||null,status:"waiting",quizId:(null==t?void 0:t.id)||null,quiz:t?{id:t.id,title:t.title,description:t.description,questions:t.questions||[]}:null,settings:{timeLimit:(null==(s=e.settings)?void 0:s.timeLimit)||30,showLeaderboard:(null==(r=e.settings)?void 0:r.showLeaderboard)??!0,allowLateJoin:(null==(a=e.settings)?void 0:a.allowLateJoin)??!0},createdAt:w()};await N(i,o);const d=y(m(u,"multiplayer_rooms",i.id,"players"),this.userId);await N(d,n),this.currentRoomId=i.id,this.listenToRoom(i.id),this.listenToPlayers(i.id),this.listenToMessages(i.id);const c={id:i.id,code:l,name:o.name,players:[n],maxPlayers:o.maxPlayers,isPrivate:o.isPrivate,password:o.password||void 0,status:"waiting",quizId:(null==t?void 0:t.id)||void 0,quiz:o.quiz||void 0,settings:o.settings,createdAt:new Date};return this.emit("room:created",c),{room:c,player:n}}catch(l){throw l}}async joinRoom(e,t){var s;try{const r=c(m(u,"multiplayer_rooms"),x("code","==",e),h(1)),a=await g(r);if(a.empty)throw new Error("room_not_found");const l=a.docs[0],i=l.data();if(i.isPrivate&&!t)throw new Error("room_requires_password");if(i.isPrivate&&i.password!==t)throw new Error("wrong_password");if((await g(m(u,"multiplayer_rooms",l.id,"players"))).size>=i.maxPlayers)throw new Error("room_full");if("playing"===i.status&&!i.settings.allowLateJoin)throw new Error("game_in_progress");const n={id:this.userId,username:this.username,isReady:!1,score:0,answers:[],joinedAt:new Date},o=y(m(u,"multiplayer_rooms",l.id,"players"),this.userId);await N(o,n),this.currentRoomId=l.id,this.listenToRoom(l.id),this.listenToPlayers(l.id),this.listenToMessages(l.id),await this.sendSystemMessage(l.id,`${this.username} joined the room`);const d={id:l.id,code:i.code,name:i.name,players:[n],maxPlayers:i.maxPlayers,isPrivate:i.isPrivate,password:i.password,status:i.status,quizId:i.quizId,quiz:i.quiz,settings:i.settings,createdAt:(null==(s=i.createdAt)?void 0:s.toDate())||new Date};return this.emit("room:joined",d),{room:d,player:n}}catch(r){throw r}}async leaveRoom(e){try{if(!this.userId)return;const t=y(u,"multiplayer_rooms",e,"players",this.userId);await C(t),await this.sendSystemMessage(e,`${this.username} left the room`),this.unsubscribeFunctions.forEach(e=>e()),this.unsubscribeFunctions=[],this.currentRoomId=null,this.emit("room:left",e)}catch(t){throw t}}async startGame(e){try{const t=y(u,"multiplayer_rooms",e);await S(t,{status:"starting",gameStartAt:w(),gameStartDelay:5e3}),setTimeout(()=>{this.actuallyStartGame(e).catch(console.error)},5e3)}catch(t){throw t}}async actuallyStartGame(e){var t;try{const r=y(u,"multiplayer_rooms",e),a=await A(r);if(!a.exists())throw new Error("Room not found");const l=a.data();let i=[];if(l.quiz&&l.quiz.questions&&l.quiz.questions.length>0)i=l.quiz.questions;else if(l.quizId)try{const e=y(u,"quizzes",l.quizId),t=await A(e);if(t.exists()){const e=t.data();(null==e?void 0:e.questions)&&Array.isArray(e.questions)&&(i=e.questions)}}catch(s){}i&&0!==i.length||(i=[{id:"mock-q1",text:"What is 2 + 2?",answers:[{text:"3",isCorrect:!1},{text:"4",isCorrect:!0},{text:"5",isCorrect:!1},{text:"6",isCorrect:!1}]},{id:"mock-q2",text:"What is the capital of Vietnam?",answers:[{text:"Ho Chi Minh City",isCorrect:!1},{text:"Hanoi",isCorrect:!0},{text:"Da Nang",isCorrect:!1},{text:"Hue",isCorrect:!1}]}]);const n=(null==(t=l.settings)?void 0:t.timePerQuestion)||30,o={currentQuestionIndex:0,questions:i,timePerQuestion:n,phase:"question",questionStartAt:w(),questionEndAt:new Date(Date.now()+1e3*n)};await S(r,{status:"playing",startedAt:w(),gameData:o,gameStartAt:null,gameStartDelay:null});const d={...o,roomId:e,questionsCount:i.length};this.emit("game:start",d)}catch(r){throw r}}async submitAnswer(e,t,s,r){var a,l,i;try{const n=y(u,"multiplayer_rooms",e,"players",this.userId),o=await A(n);if(!o.exists())return;const d=o.data(),c=y(u,"multiplayer_rooms",e),m=await A(c);if(!m.exists())return;const x=m.data(),h=(null==(a=x.gameData)?void 0:a.currentQuestionIndex)||0,g=null==(i=null==(l=x.gameData)?void 0:l.questions)?void 0:i[h];let p=!1,b=0;if(g){let e=0;g.answers&&Array.isArray(g.answers)&&(e=g.answers.findIndex(e=>e.isCorrect),-1===e&&(e=0)),p=s===e,b=p?Math.max(10,Math.floor(100-2*r)):0}const f={questionId:t,selectedAnswer:s,isCorrect:p,timeSpent:r,points:b,timestamp:new Date},v=[...d.answers||[],f];await S(n,{answers:v}),this.emit("answer:submitted",{questionId:t,answer:s,timeSpent:r,isCorrect:p,points:b}),this.checkAndAdvanceQuestion(e,t)}catch(n){throw n}}async checkAndAdvanceQuestion(e,t){try{const s=(await g(m(u,"multiplayer_rooms",e,"players"))).docs.map(e=>e.data());if(s.every(e=>{var s;return null==(s=e.answers)?void 0:s.some(e=>e.questionId===t)})&&s.length>0){const t=y(u,"multiplayer_rooms",e);await S(t,{"gameData.phase":"results","gameData.nextQuestionAt":new Date(Date.now()+3e3)}),setTimeout(async()=>{var e,s,r,a;try{const l=await A(t);if(!l.exists())return;const i=l.data(),n=(null==(e=i.gameData)?void 0:e.currentQuestionIndex)||0;if(n+1>=((null==(r=null==(s=i.gameData)?void 0:s.questions)?void 0:r.length)||0))await S(t,{status:"finished",finishedAt:w(),"gameData.phase":"finished"});else{const e=n+1,s=(null==(a=i.settings)?void 0:a.timePerQuestion)||30;await S(t,{"gameData.currentQuestionIndex":e,"gameData.phase":"question","gameData.questionStartAt":w(),"gameData.questionEndAt":new Date(Date.now()+1e3*s),"gameData.nextQuestionAt":null})}}catch(l){}},3e3)}}catch(s){}}async sendChatMessage(e,t){try{const s={userId:this.userId,username:this.username,message:t.trim(),timestamp:w(),type:"user"};await D(m(u,"multiplayer_rooms",e,"messages"),s)}catch(s){throw s}}async sendSystemMessage(e,t){try{const s={userId:"system",username:"System",message:t,timestamp:w(),type:"system"};await D(m(u,"multiplayer_rooms",e,"messages"),s)}catch(s){}}async updatePlayerStatus(e,t){try{const s=y(u,"multiplayer_rooms",e,"players",this.userId);await S(s,{isReady:t}),this.emit("player:status_updated",{isReady:t})}catch(s){throw s}}async kickPlayer(e,t){try{const s=y(u,"multiplayer_rooms",e,"players",t);await C(s),this.emit("player:kicked",t)}catch(s){throw s}}async updateRoomSettings(e,t){try{const s=y(u,"multiplayer_rooms",e);await S(s,{[`settings.${Object.keys(t)[0]}`]:Object.values(t)[0]}),this.emit("room:settings_updated",t)}catch(s){throw s}}listenToRoom(e){const t=y(u,"multiplayer_rooms",e),s=v(t,t=>{var s,r,a;if(t.exists()){const l=t.data(),i={id:t.id,code:l.code,name:l.name,players:[],maxPlayers:l.maxPlayers,isPrivate:l.isPrivate,password:l.password,status:l.status,quizId:l.quizId,quiz:l.quiz,settings:l.settings,createdAt:(null==(s=l.createdAt)?void 0:s.toDate())||new Date,startedAt:null==(r=l.startedAt)?void 0:r.toDate(),finishedAt:null==(a=l.finishedAt)?void 0:a.toDate()};if(this.emit("room:updated",i),l.gameData&&this.emit("game:data_updated",l.gameData),"starting"===l.status&&l.gameStartAt&&l.gameStartDelay){const t=1e3*("number"==typeof l.gameStartAt.seconds?l.gameStartAt.seconds:Math.floor(Date.now()/1e3))+Number(l.gameStartDelay);Date.now()>=t&&this.actuallyStartGame(e).catch(()=>{})}}});this.unsubscribeFunctions.push(s)}listenToPlayers(e){const t=m(u,"multiplayer_rooms",e,"players"),s=c(t,q("joinedAt","asc")),r=v(s,e=>{const t=[];e.forEach(e=>{var s;const r=e.data();t.push({...r,joinedAt:(null==(s=r.joinedAt)?void 0:s.toDate())||new Date})}),this.emit("players:updated",t)});this.unsubscribeFunctions.push(r)}listenToMessages(e){const t=m(u,"multiplayer_rooms",e,"messages"),s=c(t,q("timestamp","asc")),r=v(s,e=>{const t=[];e.forEach(e=>{var s;const r=e.data();t.push({id:e.id,userId:r.userId,username:r.username,message:r.message,timestamp:(null==(s=r.timestamp)?void 0:s.toDate())||new Date,type:r.type})}),this.emit("messages:updated",t)});this.unsubscribeFunctions.push(r)}generateRoomCode(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let t="";for(let s=0;s<6;s++)t+=e.charAt(Math.floor(36*Math.random()));return t}}let Z=null;const ee=({selectedQuiz:e,currentUserId:t,currentUserName:s,onBackToQuizSelection:n,onQuizComplete:o,initialRoomId:d})=>{var c;const{t:m}=r(),[u,x]=a.useState({currentState:"mode-selection",isConnecting:!1,isConnected:!1}),[h,g]=a.useState(null),[p,b]=a.useState([]),[y,f]=a.useState("disconnected"),[v,j]=a.useState(null),[w,N]=a.useState(void 0),[C,S]=a.useState(!1),[A,D]=a.useState(!1);a.useEffect(()=>{const e=(Z||(Z=new X),Z);g(e);return(async()=>{try{f("connecting"),await e.connect(t,s),f("connected"),x(e=>({...e,isConnected:!0})),e.on("room:updated",q),e.on("players:updated",E),e.on("messages:updated",_),e.on("game:start",k),e.on("game:next-question",z),e.on("game:finish",R),e.on("connection:lost",L),e.on("connection:restored",U)}catch(r){f("error"),I.error(m("multiplayer.errors.connectionFailed"))}})(),()=>{e.disconnect()}},[t,s,m]),a.useEffect(()=>{var e;const t=d||u.roomId||(null==(e=u.roomData)?void 0:e.id);t&&h&&"connected"===y&&(h.setPresence(t,!0).catch(()=>{}),h.resumeRoom(t).catch(()=>{}),x(e=>({...e,currentState:"lobby",roomId:t})))},[h,y]);const q=a.useCallback(e=>{x(t=>({...t,roomData:e}));try{const t=(null==e?void 0:e.players)||[],s=t.length,r=t.filter(e=>e.isReady).length;s>=2&&r===s&&"lobby"===u.currentState?null===v&&j(5):null!==v&&j(null)}catch(t){}},[u.currentState,v]);a.useEffect(()=>{if(null===v)return;if(v<=0)return h&&u.roomId&&h.startGame(u.roomId).then(()=>{}).catch(e=>{I.error("Failed to start game")}),void j(null);const e=setTimeout(()=>{j(e=>null!==e?e-1:null)},1e3);return()=>clearTimeout(e)},[v,h,u.roomId]);const k=a.useCallback(e=>{x(t=>({...t,currentState:"game",gameData:e}))},[m]),z=a.useCallback(e=>{x(t=>({...t,gameData:e}))},[]),R=a.useCallback(e=>{x(t=>({...t,currentState:"results",results:e})),o(e)},[o]),E=a.useCallback(e=>{x(t=>({...t,roomData:t.roomData?{...t.roomData,players:e}:void 0}))},[]),_=a.useCallback(e=>{b(e)},[]),L=a.useCallback(()=>{f("disconnected")},[m]),U=a.useCallback(()=>{f("connected")},[m]),F=e=>{x("create"===e?e=>({...e,currentState:"create-room"}):e=>({...e,currentState:"join-room"}))},O=()=>{x(e=>({...e,currentState:"mode-selection",roomId:void 0,roomData:void 0,gameData:void 0,results:void 0}))},$=(e,t)=>{x(s=>({...s,currentState:"lobby",roomId:e,roomData:t}))},G=(e,t)=>{x(s=>({...s,currentState:"lobby",roomId:e,roomData:t}))},K=()=>{h&&u.roomId&&h.leaveRoom(u.roomId),x(e=>({...e,currentState:"mode-selection",roomId:void 0,roomData:void 0,gameData:void 0,results:void 0})),I.info(m("multiplayer.success.leftRoom"))},ee=e=>{h&&u.roomId&&h.sendChatMessage(u.roomId,e).then(()=>{}).catch(e=>{})};return l.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900",children:[l.jsx("div",{className:"bg-white/10 backdrop-blur-md border-b border-white/20 p-4",children:l.jsxs("div",{className:"max-w-7xl mx-auto flex items-center justify-between",children:[l.jsxs("div",{className:"flex items-center gap-4",children:[l.jsxs("button",{onClick:n,className:"text-white hover:text-gray-200 transition-colors",children:["← ",m("common.back")]}),l.jsx("h1",{className:"text-xl font-bold text-white",children:m("multiplayer.title")})]}),l.jsxs("div",{className:"flex items-center gap-4",children:[(()=>{const e={disconnected:{icon:M,color:"text-red-500",text:m("multiplayer.errors.connectionLost")},connecting:{icon:P,color:"text-yellow-500",text:m("multiplayer.errors.reconnecting")},connected:{icon:P,color:"text-green-500",text:m("multiplayer.success.connectionRestored")},error:{icon:Q,color:"text-red-500",text:m("multiplayer.errors.connectionFailed")}}[y],t=e.icon;return l.jsxs("div",{className:`flex items-center gap-2 ${e.color} text-sm`,children:[l.jsx(t,{size:16}),l.jsx("span",{children:e.text})]})})(),u.roomData&&l.jsxs("div",{className:"flex items-center gap-2 text-white",children:[l.jsx(i,{size:16}),l.jsxs("span",{children:[(null==(c=u.roomData.players)?void 0:c.length)||0,"/",u.roomData.maxPlayers||10]})]})]})]})}),l.jsx("div",{className:"flex-1",children:(()=>{switch(u.currentState){case"mode-selection":return l.jsx(T,{isOpen:!0,onClose:n,onSelectSinglePlayer:n,onSelectMultiplayer:F,connectionStatus:y});case"create-room":return l.jsx(W,{isOpen:!0,onClose:O,onCreateRoom:async t=>{try{if(S(!0),!h||"connected"!==y)return void I.info(m("multiplayer.errors.reconnecting"));const s=await h.createRoom(t,e);s&&$(s.room.id,s.room)}catch(s){const e=s.message||m("multiplayer.errors.createRoomFailed");I.error(e)}finally{S(!1)}},onRoomCreated:$,selectedQuiz:e,currentUserId:t,currentUserName:s,multiplayerService:h,loading:C||"connected"!==y});case"join-room":return l.jsx(Y,{isOpen:!0,onClose:()=>{N(void 0),O()},onJoinRoom:async(e,t)=>{try{if(N(void 0),D(!0),!h||"connected"!==y)return void I.info(m("multiplayer.errors.reconnecting"));const s=await h.joinRoom(e,t);s&&G(s.room.id,s.room)}catch(s){const e=s.message||m("multiplayer.errors.joinRoomFailed");N(e),I.error(e)}finally{D(!1)}},onRoomJoined:G,loading:A||"connected"!==y,error:w,currentUserId:t,currentUserName:s,multiplayerService:h});case"lobby":return l.jsxs("div",{className:"flex h-screen",children:[l.jsxs("div",{className:"flex-1",children:[l.jsx(B,{roomData:u.roomData,currentUserId:t,onLeaveRoom:K,multiplayerService:h}),null!==v&&l.jsxs("div",{className:"m-4 p-3 bg-blue-50 border border-blue-200 rounded text-blue-700 inline-block",children:[m("common.start"),": ",v,"s"]})]}),l.jsx("div",{className:"w-80 border-l border-gray-200",children:l.jsx(V,{messages:p,onSendMessage:ee,currentUserId:t})})]});case"game":return l.jsxs("div",{className:"flex h-screen",children:[l.jsx("div",{className:"flex-1",children:l.jsx(H,{gameData:u.gameData,roomData:u.roomData,currentUserId:t,currentUserName:s,multiplayerService:h})}),l.jsx("div",{className:"w-80 border-l border-gray-200",children:l.jsx(V,{messages:p,onSendMessage:ee,currentUserId:t})})]});case"results":return l.jsx(J,{results:u.results,roomData:u.roomData,onPlayAgain:O,onBackToMenu:n});default:return null}})()})]})},te=()=>{const e=k(),t=z(),s=e.state,r=new URLSearchParams(e.search).get("roomId")||void 0,{user:i}=b(e=>e.auth);return a.useEffect(()=>{if(!i)return void t("/login");const e=null==s?void 0:s.selectedQuiz;e?e.questions&&0!==e.questions.length||t("/quizzes",{state:{error:"Selected quiz has no questions. Please choose a different quiz."}}):t("/quizzes",{state:{error:"Please select a quiz before starting multiplayer game"}})},[i,null==s?void 0:s.selectedQuiz,t]),i&&(null==s?void 0:s.selectedQuiz)?l.jsx("div",{className:"min-h-screen bg-gray-50",children:l.jsx(ee,{selectedQuiz:s.selectedQuiz,currentUserId:i.uid,currentUserName:i.displayName||i.email||"User",onBackToQuizSelection:()=>t("/quizzes"),onQuizComplete:()=>{},initialRoomId:r})}):l.jsx("div",{className:"min-h-screen flex items-center justify-center",children:l.jsxs("div",{className:"text-center",children:[l.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),l.jsx("p",{className:"mt-4 text-gray-600",children:"Loading..."})]})})};export{te as default};
