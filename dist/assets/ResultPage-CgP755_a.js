import{a as T,f as M,d as B,u as Q,r as x,h as P,y as j,g as U,j as e,B as p,i as K}from"./index-CNQy308a.js";import{Q as Y}from"./QuickReviewSection-DVF-4cxL.js";import{q as W}from"./quizStatsService-C_VisJyu.js";import"./ReviewForm-Dtv3lQdi.js";import"./send-jCzz2FPG.js";const G=()=>e.jsx("div",{className:"fixed inset-0 pointer-events-none overflow-hidden",children:[...Array(50)].map((i,n)=>e.jsx("div",{className:"absolute animate-bounce",style:{left:`${Math.random()*100}%`,animationDelay:`${Math.random()*3}s`,animationDuration:`${2+Math.random()*3}s`},children:e.jsx("div",{className:"w-2 h-2 bg-yellow-400 rounded-full",style:{backgroundColor:["#f59e0b","#10b981","#3b82f6","#8b5cf6","#ef4444"][Math.floor(Math.random()*5)]}})},n))}),O=({score:i})=>{const[n,l]=x.useState(0);x.useEffect(()=>{const m=setTimeout(()=>{let b=0;const c=i/50,y=setInterval(()=>{b+=c,b>=i?(l(i),clearInterval(y)):l(Math.floor(b))},20)},500);return()=>clearTimeout(m)},[i]);const v=m=>m>=80?"text-green-600":m>=60?"text-yellow-600":"text-red-600",o=2*Math.PI*45,d=o,N=o-n/100*o;return e.jsxs("div",{className:"relative w-32 h-32",children:[e.jsxs("svg",{className:"w-32 h-32 transform -rotate-90",viewBox:"0 0 100 100",children:[e.jsx("circle",{cx:"50",cy:"50",r:"45",stroke:"currentColor",strokeWidth:"6",fill:"transparent",className:"text-gray-200"}),e.jsx("circle",{cx:"50",cy:"50",r:"45",stroke:"currentColor",strokeWidth:"6",fill:"transparent",strokeDasharray:d,strokeDashoffset:N,strokeLinecap:"round",className:`transition-all duration-1000 ease-out ${n>=80?"text-green-500":n>=60?"text-yellow-500":"text-red-500"}`})]}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:`text-2xl font-bold ${v(n)}`,children:[n,"%"]})})})]})},R=i=>{const n=Math.floor(i/60),l=i%60;return`${n}:${l.toString().padStart(2,"0")}`},g=(i,n=0)=>{const l=Number(i);return isNaN(l)?n:l},Z=()=>{const{attemptId:i}=T(),n=M(),l=B(),{quizzes:v}=Q(t=>t.quiz),{user:o}=Q(t=>t.auth),[d,N]=x.useState(n.state||null),[m,b]=x.useState(null),[c,y]=x.useState(null),[k,E]=x.useState(!1),[q,$]=x.useState([]),[I,L]=x.useState(null),[D,C]=x.useState(!0);if(x.useEffect(()=>{if(console.log("🔍 ResultPage useEffect - attemptId:",i,"location.state:",n.state),n.state){const t=n.state;console.log("✅ Using state from navigation:",t),N(t),b(t.quizId||i||null)}else i?(console.log("📡 Fetching result from Firestore for attemptId:",i),P(i).then(t=>{if(t){console.log("✅ Fetched result from Firestore:",t);const s=t;N(s),b(s.quizId||null)}else console.error("❌ No result found for attemptId:",i),j.error("Không tìm thấy kết quả quiz!"),l("/quiz-list")}).catch(t=>{console.error("❌ Error fetching result:",t),j.error("Không thể tải kết quả quiz!"),l("/quiz-list")})):(console.error("❌ No attemptId or state provided"),l("/quiz-list"))},[i,n.state,l]),x.useEffect(()=>{if(!m)return;console.log("🔍 Looking for quiz with ID:",m);const t=v.find(s=>s.id===m);t?(console.log("✅ Found quiz in store:",t.title),y(t)):(console.log("📡 Quiz not in store, fetching from Firestore..."),U(m).then(s=>{s?(console.log("✅ Fetched quiz from Firestore:",s.title),y(s)):(console.error("❌ Quiz not found:",m),j.error("Không tìm thấy quiz!"),l("/quiz-list"))}).catch(s=>{console.error("❌ Error fetching quiz:",s),j.error("Không thể tải quiz!"),l("/quiz-list")}))},[m,v,l]),x.useEffect(()=>{if(d&&c&&o&&!d.tracked){console.log("📊 Tracking quiz completion for user:",o.uid);const t=g(d.correct,0),s=g(d.total,c.questions.length);W.trackCompletion(c.id,o.uid,t,s),N(h=>h?{...h,tracked:!0}:null)}},[d,c,o]),x.useEffect(()=>{(async()=>{if(m)try{C(!0),console.log("📊 Fetching leaderboard for quiz:",m);const s=await K(m);console.log("📊 Raw results from Firebase:",s);const h=s.map(r=>{var a,S,A;return console.log("🔍 Processing result:",r),{id:r.id,userId:r.userId,userName:r.userName||((a=r.userEmail)==null?void 0:a.split("@")[0])||"Anonymous",userEmail:r.userEmail||"",score:r.score,correctAnswers:r.correctAnswers,totalQuestions:r.totalQuestions,timeSpent:r.timeSpent||0,completedAt:((A=(S=r.completedAt)==null?void 0:S.toDate)==null?void 0:A.call(S))||new Date(r.completedAt)}});console.log("📊 Leaderboard data processed:",h);const f=h.sort((r,a)=>r.score!==a.score?a.score-r.score:r.timeSpent-a.timeSpent);if(console.log("📊 Sorted leaderboard:",f),$(f.slice(0,10)),o){const r=f.findIndex(a=>a.userId===o.uid);L(r>=0?r+1:null),console.log("👤 User rank:",r>=0?r+1:"Not found")}console.log("📊 Leaderboard loaded:",f.length,"entries")}catch(s){console.error("❌ Failed to fetch leaderboard:",s),j.error("Không thể tải bảng xếp hạng!")}finally{C(!1)}})()},[m,o]),!d||!c)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600 mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Loading results..."}),e.jsx(p,{onClick:()=>l("/quiz-list"),children:"Back to Quiz List"})]})});const w=g(d.correct),z=g(d.total),u=z>0?Math.round(w/z*100):0,F=u>=80;return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 py-8",children:[F&&e.jsx(G,{}),e.jsxs("div",{className:"max-w-4xl mx-auto px-4",children:[e.jsx("div",{className:"text-center mb-8",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-8 mb-6",children:[d.isTimeUp&&e.jsx("div",{className:"bg-yellow-100 border border-yellow-300 text-yellow-800 px-4 py-3 rounded-lg mb-6",children:"⏰ Time's up! Quiz was automatically submitted."}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(O,{score:u}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mt-4 mb-2",children:"Quiz Completed!"}),e.jsx("p",{className:"text-xl text-gray-600 mb-4",children:u>=90?"Outstanding! 🏆":u>=80?"Excellent! 🌟":u>=70?"Great Job! 👏":u>=60?"Good Work! 👍":u>=50?"Not Bad! 📚":"Keep Practicing! 💪"}),e.jsxs("div",{className:"text-lg text-gray-700 mb-2",children:["You got ",e.jsx("span",{className:"font-bold text-blue-600",children:w})," out of"," ",e.jsx("span",{className:"font-bold",children:z})," questions correct"]}),typeof d.timeSpent=="number"&&e.jsxs("div",{className:"text-md text-gray-500 mt-2",children:["⏱️ Time taken: ",e.jsx("span",{className:"font-semibold text-blue-700",children:R(g(d.timeSpent))})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-green-600 mb-2",children:w}),e.jsx("div",{className:"text-gray-600",children:"Correct Answers"})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-red-600 mb-2",children:z-w}),e.jsx("div",{className:"text-gray-600",children:"Incorrect Answers"})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 text-center",children:[e.jsxs("div",{className:"text-3xl font-bold text-blue-600 mb-2",children:[u,"%"]}),e.jsx("div",{className:"text-gray-600",children:"Final Score"})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 mb-8",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"Performance Analysis"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Accuracy Rate"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-32 bg-gray-200 rounded-full h-2 mr-3",children:e.jsx("div",{className:"bg-blue-500 h-2 rounded-full transition-all duration-1000",style:{width:`${u}%`}})}),e.jsxs("span",{className:"font-semibold",children:[u,"%"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Quiz Difficulty"}),e.jsx("span",{className:`px-3 py-1 rounded-full text-sm font-medium ${c.difficulty==="easy"?"bg-green-100 text-green-800":c.difficulty==="medium"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:c.difficulty.charAt(0).toUpperCase()+c.difficulty.slice(1)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Time Management"}),e.jsx("span",{className:"font-semibold text-green-600",children:d.isTimeUp?"Used full time":"Completed early"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 mb-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Review Answers"}),e.jsxs(p,{variant:"outline",onClick:()=>E(!k),children:[k?"Hide":"Show"," Detailed Review"]})]}),k&&e.jsx("div",{className:"space-y-6",children:c.questions.map((t,s)=>{const h=d.answers[t.id],f=t.answers.find(a=>a.id===h),r=(f==null?void 0:f.isCorrect)||!1;return e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900",children:[s+1,". ",t.text]}),e.jsx("span",{className:`px-3 py-1 rounded-full text-sm font-medium ${r?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:r?"✓ Correct":"✗ Incorrect"})]}),e.jsx("div",{className:"space-y-2",children:t.answers.map(a=>e.jsx("div",{className:`p-3 rounded-lg border ${a.isCorrect?"border-green-300 bg-green-50":a.id===h?"border-red-300 bg-red-50":"border-gray-200 bg-gray-50"}`,children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs("span",{className:"font-medium mr-3",children:[String.fromCharCode(65+t.answers.indexOf(a)),"."]}),e.jsx("span",{children:a.text}),a.isCorrect&&e.jsx("span",{className:"ml-auto text-green-600 font-medium",children:"✓ Correct Answer"}),a.id===h&&!a.isCorrect&&e.jsx("span",{className:"ml-auto text-red-600 font-medium",children:"Your Answer"})]})},a.id))}),t.explanation&&e.jsxs("div",{className:"mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-800",children:"Explanation: "}),e.jsx("span",{className:"text-blue-700",children:t.explanation})]})]},t.id)})})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-8 mb-8",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-6",children:"🏆 Leaderboard"}),D?e.jsxs("div",{className:"flex justify-center items-center h-24",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Loading leaderboard..."})]}):q.length>0?e.jsxs("div",{className:"space-y-3",children:[q.map((t,s)=>e.jsxs("div",{className:`flex items-center justify-between p-4 rounded-lg border ${t.userId===(o==null?void 0:o.uid)?"bg-blue-50 border-blue-200 shadow-md":"bg-gray-50 border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${s===0?"bg-yellow-400 text-yellow-900":s===1?"bg-gray-300 text-gray-700":s===2?"bg-amber-600 text-amber-100":"bg-gray-200 text-gray-600"}`,children:s===0?"🥇":s===1?"🥈":s===2?"🥉":s+1}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-gray-900",children:[t.userName,t.userId===(o==null?void 0:o.uid)&&e.jsx("span",{className:"text-blue-600 ml-2",children:"(You)"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[t.correctAnswers,"/",t.totalQuestions," correct"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-bold text-xl text-gray-900",children:[g(t.score),"%"]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["⏱️ ",R(g(t.timeSpent))]})]})]},t.id)),o&&I&&I>10&&e.jsx("div",{className:"mt-6 pt-4 border-t border-gray-200",children:e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsx("div",{className:"text-center",children:e.jsxs("span",{className:"text-blue-800 font-medium",children:["Your Rank: #",I]})})})})]}):e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx("div",{className:"text-6xl mb-4",children:"🏆"}),e.jsx("p",{className:"text-lg",children:"No results yet!"}),e.jsx("p",{children:"Be the first to complete this quiz and claim the top spot!"})]})]}),c&&e.jsx("div",{className:"mb-8",children:e.jsx(Y,{quizId:c.id,quizTitle:c.title})}),e.jsxs("div",{className:"flex flex-wrap gap-4 justify-center",children:[e.jsx(p,{onClick:()=>l(`/quiz/${c.id}`),className:"bg-blue-600 hover:bg-blue-700",children:"Retake Quiz"}),e.jsx(p,{onClick:()=>l("/quizzes"),variant:"outline",children:"More Quizzes"}),e.jsx(p,{variant:"outline",onClick:()=>{navigator.clipboard.writeText(`I scored ${u}% on "${c.title}" quiz! 🎯`),j.success("Result copied to clipboard!")},children:"Share Result"}),e.jsx(p,{onClick:()=>l("/profile"),variant:"outline",children:"View All Results"})]})]})]})};export{Z as ResultPage,Z as default};
