import{a as M,q as T,b as B,u as Q,r as m,t as P,y as b,k as U,j as e,v as j,w as K}from"./index-CF88gCND.js";import{Q as Y}from"./QuickReviewSection-C_WAdlb-.js";import"./ReviewForm-KQeceWlQ.js";const W=()=>e.jsx("div",{className:"fixed inset-0 pointer-events-none overflow-hidden",children:[...Array(50)].map((i,n)=>e.jsx("div",{className:"absolute animate-bounce",style:{left:`${Math.random()*100}%`,animationDelay:`${Math.random()*3}s`,animationDuration:`${2+Math.random()*3}s`},children:e.jsx("div",{className:"w-2 h-2 bg-yellow-400 rounded-full",style:{backgroundColor:["#f59e0b","#10b981","#3b82f6","#8b5cf6","#ef4444"][Math.floor(Math.random()*5)]}})},n))}),G=({score:i})=>{const[n,l]=m.useState(0);m.useEffect(()=>{const o=setTimeout(()=>{let f=0;const d=i/50,y=setInterval(()=>{f+=d,f>=i?(l(i),clearInterval(y)):l(Math.floor(f))},20)},500);return()=>clearTimeout(o)},[i]);const N=o=>o>=80?"text-green-600":o>=60?"text-yellow-600":"text-red-600",c=2*Math.PI*45,u=c,v=c-n/100*c;return e.jsxs("div",{className:"relative w-32 h-32",children:[e.jsxs("svg",{className:"w-32 h-32 transform -rotate-90",viewBox:"0 0 100 100",children:[e.jsx("circle",{cx:"50",cy:"50",r:"45",stroke:"currentColor",strokeWidth:"6",fill:"transparent",className:"text-gray-200"}),e.jsx("circle",{cx:"50",cy:"50",r:"45",stroke:"currentColor",strokeWidth:"6",fill:"transparent",strokeDasharray:u,strokeDashoffset:v,strokeLinecap:"round",className:`transition-all duration-1000 ease-out ${n>=80?"text-green-500":n>=60?"text-yellow-500":"text-red-500"}`})]}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsxs("div",{className:`text-2xl font-bold ${N(n)}`,children:[n,"%"]})})})]})},R=i=>{const n=Math.floor(i/60),l=i%60;return`${n}:${l.toString().padStart(2,"0")}`},p=(i,n=0)=>{const l=Number(i);return isNaN(l)?n:l},V=()=>{const{attemptId:i}=M(),n=T(),l=B(),{quizzes:N}=Q(s=>s.quiz),{user:c}=Q(s=>s.auth),[u,v]=m.useState(n.state||null),[o,f]=m.useState(null),[d,y]=m.useState(null),[k,$]=m.useState(!1),[C,E]=m.useState([]),[I,L]=m.useState(null),[D,q]=m.useState(!0);if(m.useEffect(()=>{if(console.log("🔍 ResultPage useEffect - attemptId:",i,"location.state:",n.state),n.state){const s=n.state;console.log("✅ Using state from navigation:",s),v(s),f(s.quizId||i||null)}else i?(console.log("📡 Fetching result from Firestore for attemptId:",i),P(i).then(s=>{if(s){console.log("✅ Fetched result from Firestore:",s);const t=s;v(t),f(t.quizId||null)}else console.error("❌ No result found for attemptId:",i),b.error("Không tìm thấy kết quả quiz!"),l("/quiz-list")}).catch(s=>{console.error("❌ Error fetching result:",s),b.error("Không thể tải kết quả quiz!"),l("/quiz-list")})):(console.error("❌ No attemptId or state provided"),l("/quiz-list"))},[i,n.state,l]),m.useEffect(()=>{if(!o)return;console.log("🔍 Looking for quiz with ID:",o);const s=N.find(t=>t.id===o);s?(console.log("✅ Found quiz in store:",s.title),y(s)):(console.log("📡 Quiz not in store, fetching from Firestore..."),U(o).then(t=>{t?(console.log("✅ Fetched quiz from Firestore:",t.title),y(t)):(console.error("❌ Quiz not found:",o),b.error("Không tìm thấy quiz!"),l("/quiz-list"))}).catch(t=>{console.error("❌ Error fetching quiz:",t),b.error("Không thể tải quiz!"),l("/quiz-list")}))},[o,N,l]),m.useEffect(()=>{(async()=>{if(o)try{q(!0),console.log("📊 Fetching leaderboard for quiz:",o);const t=await K(o);console.log("📊 Raw results from Firebase:",t);const g=t.map(r=>{var a,S,A;return console.log("🔍 Processing result:",r),{id:r.id,userId:r.userId,userName:r.userName||((a=r.userEmail)==null?void 0:a.split("@")[0])||"Anonymous",userEmail:r.userEmail||"",score:r.score,correctAnswers:r.correctAnswers,totalQuestions:r.totalQuestions,timeSpent:r.timeSpent||0,completedAt:((A=(S=r.completedAt)==null?void 0:S.toDate)==null?void 0:A.call(S))||new Date(r.completedAt)}});console.log("📊 Leaderboard data processed:",g);const h=g.sort((r,a)=>r.score!==a.score?a.score-r.score:r.timeSpent-a.timeSpent);if(console.log("📊 Sorted leaderboard:",h),E(h.slice(0,10)),c){const r=h.findIndex(a=>a.userId===c.uid);L(r>=0?r+1:null),console.log("👤 User rank:",r>=0?r+1:"Not found")}console.log("📊 Leaderboard loaded:",h.length,"entries")}catch(t){console.error("❌ Failed to fetch leaderboard:",t),b.error("Không thể tải bảng xếp hạng!")}finally{q(!1)}})()},[o,c]),!u||!d)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600 mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Loading results..."}),e.jsx(j,{onClick:()=>l("/quiz-list"),children:"Back to Quiz List"})]})});const w=p(u.correct),z=p(u.total),x=z>0?Math.round(w/z*100):0,F=x>=80;return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 py-8",children:[F&&e.jsx(W,{}),e.jsxs("div",{className:"max-w-4xl mx-auto px-4",children:[e.jsx("div",{className:"text-center mb-8",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-8 mb-6",children:[u.isTimeUp&&e.jsx("div",{className:"bg-yellow-100 border border-yellow-300 text-yellow-800 px-4 py-3 rounded-lg mb-6",children:"⏰ Time's up! Quiz was automatically submitted."}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(G,{score:x}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mt-4 mb-2",children:"Quiz Completed!"}),e.jsx("p",{className:"text-xl text-gray-600 mb-4",children:x>=90?"Outstanding! 🏆":x>=80?"Excellent! 🌟":x>=70?"Great Job! 👏":x>=60?"Good Work! 👍":x>=50?"Not Bad! 📚":"Keep Practicing! 💪"}),e.jsxs("div",{className:"text-lg text-gray-700 mb-2",children:["You got ",e.jsx("span",{className:"font-bold text-blue-600",children:w})," out of"," ",e.jsx("span",{className:"font-bold",children:z})," questions correct"]}),typeof u.timeSpent=="number"&&e.jsxs("div",{className:"text-md text-gray-500 mt-2",children:["⏱️ Time taken: ",e.jsx("span",{className:"font-semibold text-blue-700",children:R(p(u.timeSpent))})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-green-600 mb-2",children:w}),e.jsx("div",{className:"text-gray-600",children:"Correct Answers"})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-red-600 mb-2",children:z-w}),e.jsx("div",{className:"text-gray-600",children:"Incorrect Answers"})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 text-center",children:[e.jsxs("div",{className:"text-3xl font-bold text-blue-600 mb-2",children:[x,"%"]}),e.jsx("div",{className:"text-gray-600",children:"Final Score"})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 mb-8",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"Performance Analysis"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Accuracy Rate"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-32 bg-gray-200 rounded-full h-2 mr-3",children:e.jsx("div",{className:"bg-blue-500 h-2 rounded-full transition-all duration-1000",style:{width:`${x}%`}})}),e.jsxs("span",{className:"font-semibold",children:[x,"%"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Quiz Difficulty"}),e.jsx("span",{className:`px-3 py-1 rounded-full text-sm font-medium ${d.difficulty==="easy"?"bg-green-100 text-green-800":d.difficulty==="medium"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:d.difficulty.charAt(0).toUpperCase()+d.difficulty.slice(1)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Time Management"}),e.jsx("span",{className:"font-semibold text-green-600",children:u.isTimeUp?"Used full time":"Completed early"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 mb-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Review Answers"}),e.jsxs(j,{variant:"outline",onClick:()=>$(!k),children:[k?"Hide":"Show"," Detailed Review"]})]}),k&&e.jsx("div",{className:"space-y-6",children:d.questions.map((s,t)=>{const g=u.answers[s.id],h=s.answers.find(a=>a.id===g),r=(h==null?void 0:h.isCorrect)||!1;return e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900",children:[t+1,". ",s.text]}),e.jsx("span",{className:`px-3 py-1 rounded-full text-sm font-medium ${r?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:r?"✓ Correct":"✗ Incorrect"})]}),e.jsx("div",{className:"space-y-2",children:s.answers.map(a=>e.jsx("div",{className:`p-3 rounded-lg border ${a.isCorrect?"border-green-300 bg-green-50":a.id===g?"border-red-300 bg-red-50":"border-gray-200 bg-gray-50"}`,children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs("span",{className:"font-medium mr-3",children:[String.fromCharCode(65+s.answers.indexOf(a)),"."]}),e.jsx("span",{children:a.text}),a.isCorrect&&e.jsx("span",{className:"ml-auto text-green-600 font-medium",children:"✓ Correct Answer"}),a.id===g&&!a.isCorrect&&e.jsx("span",{className:"ml-auto text-red-600 font-medium",children:"Your Answer"})]})},a.id))}),s.explanation&&e.jsxs("div",{className:"mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("span",{className:"font-medium text-blue-800",children:"Explanation: "}),e.jsx("span",{className:"text-blue-700",children:s.explanation})]})]},s.id)})})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-8 mb-8",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-6",children:"🏆 Leaderboard"}),D?e.jsxs("div",{className:"flex justify-center items-center h-24",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Loading leaderboard..."})]}):C.length>0?e.jsxs("div",{className:"space-y-3",children:[C.map((s,t)=>e.jsxs("div",{className:`flex items-center justify-between p-4 rounded-lg border ${s.userId===(c==null?void 0:c.uid)?"bg-blue-50 border-blue-200 shadow-md":"bg-gray-50 border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${t===0?"bg-yellow-400 text-yellow-900":t===1?"bg-gray-300 text-gray-700":t===2?"bg-amber-600 text-amber-100":"bg-gray-200 text-gray-600"}`,children:t===0?"🥇":t===1?"🥈":t===2?"🥉":t+1}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-gray-900",children:[s.userName,s.userId===(c==null?void 0:c.uid)&&e.jsx("span",{className:"text-blue-600 ml-2",children:"(You)"})]}),e.jsxs("div",{className:"text-sm text-gray-500",children:[s.correctAnswers,"/",s.totalQuestions," correct"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-bold text-xl text-gray-900",children:[p(s.score),"%"]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["⏱️ ",R(p(s.timeSpent))]})]})]},s.id)),c&&I&&I>10&&e.jsx("div",{className:"mt-6 pt-4 border-t border-gray-200",children:e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsx("div",{className:"text-center",children:e.jsxs("span",{className:"text-blue-800 font-medium",children:["Your Rank: #",I]})})})})]}):e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx("div",{className:"text-6xl mb-4",children:"🏆"}),e.jsx("p",{className:"text-lg",children:"No results yet!"}),e.jsx("p",{children:"Be the first to complete this quiz and claim the top spot!"})]})]}),d&&e.jsx("div",{className:"mb-8",children:e.jsx(Y,{quizId:d.id,quizTitle:d.title})}),e.jsxs("div",{className:"flex flex-wrap gap-4 justify-center",children:[e.jsx(j,{onClick:()=>l(`/quiz/${d.id}`),className:"bg-blue-600 hover:bg-blue-700",children:"Retake Quiz"}),e.jsx(j,{onClick:()=>l("/quizzes"),variant:"outline",children:"More Quizzes"}),e.jsx(j,{variant:"outline",onClick:()=>{navigator.clipboard.writeText(`I scored ${x}% on "${d.title}" quiz! 🎯`),b.success("Result copied to clipboard!")},children:"Share Result"}),e.jsx(j,{onClick:()=>l("/profile"),variant:"outline",children:"View All Results"})]})]})]})};export{V as ResultPage,V as default};
