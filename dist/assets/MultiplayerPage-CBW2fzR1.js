var e=Object.defineProperty,t=(t,s,r)=>((t,s,r)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r)(t,"symbol"!=typeof s?s+"":s,r);import{d as s,a as r,r as a,j as i,W as l,o as n,a5 as o,R as d,q as c,m,h as u,w as x,z as h,n as g,C as p,u as b,g as y,X as f,a6 as v,G as j,t as w,i as N,s as D,_ as I,x as S,p as q,v as C,y as P,D as k,l as R}from"./index-D6N84099.js";import{S as A,C as z,W as Q,a as T,G as M}from"./GameModeSelector-Yh0nKn_C.js";import{X as L}from"./x-DWlRL9Pr.js";import{C as E}from"./circle-alert-B7uhiWI6.js";import{T as _}from"./trophy-DX0mlVvR.js";import{A as U}from"./award-DBPFOSFJ.js";import{M as O}from"./message-square-C3FRacVx.js";import{S as F}from"./send-B7zzNq9k.js";
/**
 * @license lucide-react v0.536.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=s("copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]),$=s("log-out",[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]]),H=s("medal",[["path",{d:"M7.21 15 2.66 7.14a2 2 0 0 1 .13-2.2L4.4 2.8A2 2 0 0 1 6 2h12a2 2 0 0 1 1.6.8l1.6 2.14a2 2 0 0 1 .14 2.2L16.79 15",key:"143lza"}],["path",{d:"M11 12 5.12 2.2",key:"qhuxz6"}],["path",{d:"m13 12 5.88-9.8",key:"hbye0f"}],["path",{d:"M8 7h8",key:"i86dvs"}],["circle",{cx:"12",cy:"17",r:"5",key:"qbz8iq"}],["path",{d:"M12 18v-2h-.5",key:"fawc4q"}]]),J=({isOpen:e,onClose:t,onCreateRoom:s,selectedQuiz:d,loading:c=!1})=>{var m;const{t:u}=r(),[x,h]=a.useState(""),[g,p]=a.useState(4),[b,y]=a.useState(30),[f,v]=a.useState(!1),[j,w]=a.useState(""),[N,D]=a.useState(!0);return e?i.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:i.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto",children:[i.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[i.jsx("h2",{className:"text-xl font-bold text-gray-900",children:u("multiplayer.createRoom")}),i.jsx("button",{onClick:t,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:i.jsx(L,{className:"w-5 h-5"})})]}),i.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),!x.trim())return;const t={name:x.trim(),maxPlayers:g,isPrivate:f,password:f?j:void 0,settings:{timePerQuestion:b,showLeaderboard:N,allowLateJoin:!0}};s(t)},className:"p-6 space-y-6",children:[i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:u("multiplayer.roomName")}),i.jsx("input",{type:"text",value:x,onChange:e=>h(e.target.value),placeholder:u("multiplayer.enterRoomName"),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0,disabled:c})]}),i.jsxs("div",{children:[i.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[i.jsx(l,{className:"w-4 h-4 inline mr-2"}),u("multiplayer.maxPlayers")," (1-20)"]}),i.jsx("input",{type:"number",value:g,onChange:e=>{const t=parseInt(e.target.value);t>=1&&t<=20&&p(t)},min:"1",max:"20",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0,disabled:c})]}),i.jsxs("div",{children:[i.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[i.jsx(n,{className:"w-4 h-4 inline mr-2"}),u("multiplayer.timeLimit")," (giây, tối đa 1000)"]}),i.jsx("input",{type:"number",value:b,onChange:e=>{const t=parseInt(e.target.value);t>=5&&t<=1e3&&y(t)},min:"5",max:"1000",placeholder:"VD: 30",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0,disabled:c}),i.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Từ 5 đến 1000 giây cho mỗi câu hỏi"})]}),i.jsxs("div",{className:"space-y-4",children:[i.jsxs("h3",{className:"text-sm font-medium text-gray-700 flex items-center",children:[i.jsx(A,{className:"w-4 h-4 mr-2"}),u("multiplayer.roomSettings")]}),i.jsxs("div",{className:"flex items-center",children:[i.jsx("input",{type:"checkbox",id:"showLeaderboard",checked:N,onChange:e=>D(e.target.checked),className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500",disabled:c}),i.jsx("label",{htmlFor:"showLeaderboard",className:"ml-2 text-sm text-gray-700",children:u("multiplayer.showLeaderboard")})]}),i.jsxs("div",{className:"flex items-center",children:[i.jsx("input",{type:"checkbox",id:"isPrivate",checked:f,onChange:e=>v(e.target.checked),className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500",disabled:c}),i.jsxs("label",{htmlFor:"isPrivate",className:"ml-2 text-sm text-gray-700 flex items-center",children:[i.jsx(o,{className:"w-4 h-4 mr-1"}),u("multiplayer.private")]})]}),f&&i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:u("multiplayer.password")}),i.jsx("input",{type:"password",value:j,onChange:e=>w(e.target.value),placeholder:u("multiplayer.enterPassword"),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:f,disabled:c})]})]}),d&&i.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[i.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:u("quiz.selectedQuiz")}),i.jsxs("div",{className:"text-sm text-blue-800",children:[i.jsx("div",{className:"font-medium",children:d.title}),i.jsxs("div",{className:"text-blue-600",children:[(null==(m=d.questions)?void 0:m.length)||0," câu hỏi"]})]})]}),i.jsxs("div",{className:"flex gap-3 pt-4",children:[i.jsx("button",{type:"button",onClick:t,className:"flex-1 px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors",disabled:c,children:u("common.cancel")}),i.jsx("button",{type:"submit",className:"flex-1 px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors font-medium",disabled:c,children:u(c?"common.loading":"multiplayer.createRoom")})]})]})]})}):null},B=({isOpen:e,onClose:t,onJoinRoom:s,loading:l=!1,error:n})=>{const{t:p}=r(),[b,y]=a.useState(""),[f,v]=a.useState(""),[j,w]=a.useState(!1),[N,D]=a.useState("code"),[I,S]=a.useState(!1),q=()=>{y(""),v(""),w(!1),D("code"),t()};return d.useEffect(()=>{if(!n)return;const e=n.toLowerCase();(e.includes("yêu cầu mật khẩu")||e.includes("password"))&&(D("password"),w(!0))},[n]),d.useEffect(()=>{(async()=>{const e=b.trim().toUpperCase();if("code"===N&&6===e.length&&!l&&!I)try{S(!0);const t=c(m(u,"multiplayer_rooms"),x("code","==",e),h(1)),s=await g(t);if(!s.empty){s.docs[0].data().isPrivate&&(w(!0),D("password"))}}catch(t){}finally{S(!1)}})()},[b,N,l,I]),e?i.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:i.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-md w-full",children:[i.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[i.jsx("h2",{className:"text-xl font-bold text-gray-900",children:p("multiplayer.joinRoom")}),i.jsx("button",{onClick:q,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:i.jsx(L,{className:"w-5 h-5"})})]}),i.jsxs("form",{onSubmit:e=>{if(e.preventDefault(),"code"===N){if(!b.trim())return;s(b.trim().toUpperCase())}else if("password"===N){if(!f.trim())return;s(b.trim().toUpperCase(),f.trim())}},className:"p-6 space-y-6",children:[i.jsxs("div",{children:[i.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:p("multiplayer.roomCode")}),i.jsx("input",{type:"text",value:b,onChange:e=>y(e.target.value.toUpperCase()),placeholder:p("multiplayer.enterRoomCode"),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-lg font-mono tracking-wider",maxLength:6,required:!0,disabled:l||"password"===N}),i.jsx("div",{className:"text-xs text-gray-500 mt-1 text-center",children:p("multiplayer.roomCodeHint")})]}),j&&i.jsxs("div",{children:[i.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[i.jsx(o,{className:"w-4 h-4 inline mr-2"}),p("multiplayer.password")]}),i.jsx("input",{type:"password",value:f,onChange:e=>v(e.target.value),placeholder:p("multiplayer.enterPassword"),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:"password"===N,disabled:l})]}),n&&"Phòng này yêu cầu mật khẩu"!==n&&i.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 border border-red-200 rounded-lg",children:[i.jsx(E,{className:"w-5 h-5 text-red-600 flex-shrink-0"}),i.jsx("span",{className:"text-red-700 text-sm",children:n})]}),"password"===N&&i.jsxs("div",{className:"flex items-center gap-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:[i.jsx(o,{className:"w-5 h-5 text-yellow-600 flex-shrink-0"}),i.jsx("span",{className:"text-yellow-700 text-sm",children:p("multiplayer.passwordRequired")})]}),i.jsxs("div",{className:"flex gap-3 pt-4",children:[i.jsx("button",{type:"button",onClick:q,className:"flex-1 px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors",disabled:l,children:p("common.cancel")}),"password"===N&&i.jsx("button",{type:"button",onClick:()=>{D("code"),w(!1),v("")},className:"px-4 py-2 text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors",disabled:l,children:p("common.back")}),i.jsx("button",{type:"submit",className:"flex-1 px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors font-medium disabled:opacity-50",disabled:l||!b.trim()||"password"===N&&!f.trim(),children:l?i.jsxs("div",{className:"flex items-center justify-center gap-2",children:[i.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),p("common.loading")]}):p("code"===N?"multiplayer.joinRoom":"common.submit")})]})]})]})}):null},V=({roomData:e,currentUserId:t,onLeaveRoom:s,multiplayerService:o})=>{const{t:d}=r(),[c,m]=a.useState(!1),[u,x]=a.useState(null),h=(null==e?void 0:e.players)||[],g=a.useMemo(()=>h.filter(e=>e.isReady).length,[h]),b=a.useMemo(()=>h.length>=2&&h.every(e=>e.isReady),[h]),y=h.find(e=>e.id===t),f=(null==e?void 0:e.hostId)===t;a.useEffect(()=>{if(f&&b&&h.length>=2){x(5);const t=setInterval(()=>{x(s=>null===s||s<=1?(clearInterval(t),o&&(null==e?void 0:e.id)&&o.startGame(e.id),null):s-1)},1e3);return()=>clearInterval(t)}x(null)},[f,b,h.length,o,null==e?void 0:e.id]);return e?i.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100 p-4 lg:p-6",children:i.jsxs("div",{className:"max-w-7xl mx-auto",children:[i.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-6 mb-6",children:[i.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-4",children:[i.jsxs("div",{children:[i.jsx("h2",{className:"text-2xl sm:text-3xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent",children:e.name}),i.jsxs("div",{className:"flex flex-wrap items-center gap-4 mt-3",children:[i.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[i.jsx(l,{size:18,className:"text-blue-500"}),i.jsx("span",{className:"font-semibold",children:h.length}),i.jsxs("span",{className:"text-sm",children:["/",e.maxPlayers," ",d("multiplayer.players")]})]}),i.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[i.jsx(p,{size:18,className:"text-green-500"}),i.jsx("span",{className:"font-semibold",children:g}),i.jsx("span",{className:"text-sm",children:d("multiplayer.ready")})]}),i.jsxs("button",{onClick:async()=>{if(null==e?void 0:e.code)try{await navigator.clipboard.writeText(e.code),m(!0),setTimeout(()=>m(!1),2e3)}catch(t){}},className:"inline-flex items-center gap-2 px-3 py-2 rounded-lg font-medium transition-all "+(c?"bg-green-100 text-green-700 border border-green-200":"bg-blue-100 text-blue-700 border border-blue-200 hover:bg-blue-200"),children:[i.jsx(G,{size:16}),i.jsx("span",{className:"font-mono text-lg",children:e.code}),c&&i.jsx("span",{className:"text-xs",children:"Copied!"})]})]})]}),i.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-3",children:[u&&i.jsxs("div",{className:"flex items-center justify-center gap-2 bg-orange-100 text-orange-700 px-4 py-2 rounded-xl font-bold",children:[i.jsx(n,{size:18}),i.jsxs("span",{children:[d("multiplayer.startingIn")," ",u,"s"]})]}),i.jsxs("div",{className:"flex gap-2",children:[i.jsxs("button",{onClick:s,className:"px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl border border-gray-300 transition-colors flex items-center gap-2",children:[i.jsx($,{size:16}),d("multiplayer.leaveRoom")]}),i.jsxs("button",{onClick:async()=>{if(!o||!(null==e?void 0:e.id))return;const t=!(null==y?void 0:y.isReady);await o.updatePlayerStatus(e.id,t)},className:"px-6 py-3 rounded-xl font-semibold transition-all transform hover:scale-105 flex items-center gap-2 shadow-lg "+((null==y?void 0:y.isReady)?"bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white":"bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white"),children:[i.jsx(p,{size:18}),(null==y?void 0:y.isReady)?d("multiplayer.notReady"):d("multiplayer.ready")]})]})]})]}),i.jsxs("div",{className:"grid grid-cols-3 gap-4 mt-6",children:[i.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-4 text-center",children:[i.jsx("div",{className:"text-2xl font-bold text-blue-600",children:h.length}),i.jsx("div",{className:"text-sm text-blue-700",children:d("multiplayer.totalPlayers")})]}),i.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-4 text-center",children:[i.jsx("div",{className:"text-2xl font-bold text-green-600",children:g}),i.jsx("div",{className:"text-sm text-green-700",children:d("multiplayer.readyPlayers")})]}),i.jsxs("div",{className:"bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-4 text-center",children:[i.jsxs("div",{className:"text-2xl font-bold text-purple-600",children:[e.settings.timeLimit,"s"]}),i.jsx("div",{className:"text-sm text-purple-700",children:d("multiplayer.timePerQuestion")})]})]})]}),i.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:[h.map(e=>i.jsxs("div",{className:"bg-white rounded-2xl p-6 shadow-lg border-2 transition-all duration-200 "+(e.id===t?"border-blue-400 bg-gradient-to-br from-blue-50 to-indigo-50":"border-gray-200 hover:border-gray-300"),children:[i.jsx("div",{className:"flex items-center justify-between mb-4",children:i.jsxs("div",{className:"flex items-center gap-4",children:[i.jsxs("div",{className:"relative w-14 h-14 rounded-2xl flex items-center justify-center text-white font-bold text-lg bg-gradient-to-br from-blue-500 to-purple-600",children:[e.username.charAt(0).toUpperCase(),e.isHost&&i.jsx(z,{className:"absolute -top-2 -right-2 w-5 h-5 text-yellow-500"})]}),i.jsxs("div",{className:"min-w-0 flex-1",children:[i.jsxs("div",{className:"font-bold text-gray-800 text-lg flex items-center gap-2",children:[i.jsx("span",{className:"truncate",children:e.username}),e.id===t&&i.jsx("span",{className:"text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full shrink-0",children:d("common.you")})]}),i.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[i.jsx("div",{className:"w-2 h-2 rounded-full "+(e.isOnline?"bg-green-400":"bg-gray-400")}),i.jsx("span",{className:"text-sm text-gray-600",children:e.isOnline?d("common.online"):d("common.offline")})]})]})]})}),i.jsx("div",{className:"flex items-center justify-center",children:i.jsx("div",{className:"flex items-center gap-2 px-3 py-2 rounded-xl font-medium w-full justify-center "+(e.isReady?"bg-green-100 text-green-700 border border-green-200":"bg-gray-100 text-gray-600 border border-gray-200"),children:e.isReady?i.jsxs(i.Fragment,{children:[i.jsx(p,{size:16}),i.jsx("span",{children:d("multiplayer.ready")})]}):i.jsxs(i.Fragment,{children:[i.jsx(n,{size:16}),i.jsx("span",{children:d("multiplayer.waiting")})]})})})]},e.id)),Array.from({length:Math.max(0,e.maxPlayers-h.length)}).map((e,t)=>i.jsx("div",{className:"bg-gray-50 border-2 border-dashed border-gray-300 rounded-2xl p-6 flex items-center justify-center text-gray-400 min-h-[120px]",children:i.jsxs("div",{className:"text-center",children:[i.jsx(l,{size:24,className:"mx-auto mb-2 opacity-50"}),i.jsx("div",{className:"text-sm font-medium",children:d("multiplayer.waitingForPlayer")})]})},`empty-${t}`))]})]})}):i.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:i.jsxs("div",{className:"text-center",children:[i.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600 mx-auto"}),i.jsx("p",{className:"mt-4 text-gray-600",children:d("common.loading")})]})})},W={},Y=({gameData:e,roomData:t,multiplayerService:s})=>{var r,o,d,c,m,u;const[x,h]=a.useState(null),[g,j]=a.useState(!1),[w,N]=a.useState(!1),[D,I]=a.useState(null),[S,q]=a.useState(null),[C,P]=a.useState(null),[k,R]=a.useState(0),[A,z]=a.useState(e),[Q,T]=a.useState(t),[M,L]=a.useState({}),[_,U]=a.useState({}),[O,F]=a.useState({}),G=a.useRef(null),$=a.useRef(null),H=a.useRef(null),J=a.useRef(-1),B=A||e,V=Q||t,Y=(null==B?void 0:B.timePerQuestion)??(null==(r=null==V?void 0:V.settings)?void 0:r.timePerQuestion)??30,[K,X]=a.useState(Y),Z=b(e=>e.auth.user),ee=(null==B?void 0:B.phase)||"question",te=(null==V?void 0:V.status)||"waiting";a.useEffect(()=>{if(!(null==t?void 0:t.id))return;const e=y(f,"multiplayer_rooms",t.id),s=v(e,e=>{var t,s,r,a,i,l;if(e.exists()){const n={id:e.id,...e.data()};if(T(n),n.gameData&&z(n.gameData),"starting"===n.status)if(n.gameStartAt){const e=new Date(1e3*n.gameStartAt.seconds),t=new Date,s=Math.max(0,Math.ceil((e.getTime()-t.getTime())/1e3));P(s>0?s:0)}else P(5);if((null==(t=n.gameData)?void 0:t.questionEndAt)&&"question"===(null==(s=n.gameData)?void 0:s.phase)){const e=new Date(1e3*n.gameData.questionEndAt.seconds),t=new Date,s=Math.max(0,Math.ceil((e.getTime()-t.getTime())/1e3));s>0&&(R(s),X(s))}const o=(null==(r=n.gameData)?void 0:r.currentQuestionIndex)??0;if(o!==J.current&&(J.current=o,h(null),j(!1),N(!1),I(null),X(Y),F({}),G.current&&(window.clearTimeout(G.current),G.current=null),$.current&&(window.clearTimeout($.current),$.current=null)),"results"===(null==(a=n.gameData)?void 0:a.phase)&&(null==(i=n.gameData)?void 0:i.nextQuestionAt)){const e=new Date(1e3*n.gameData.nextQuestionAt.seconds),t=new Date,s=Math.max(0,Math.ceil((e.getTime()-t.getTime())/1e3));s>0&&(N(!0),q(s))}"finished"===(null==(l=n.gameData)?void 0:l.phase)&&(N(!0),q(null))}},e=>{});return()=>{s(),G.current&&(window.clearTimeout(G.current),G.current=null),$.current&&(window.clearTimeout($.current),$.current=null),H.current&&(window.clearTimeout(H.current),H.current=null)}},[null==t?void 0:t.id]),a.useEffect(()=>(null!==C&&C>0&&(H.current=window.setTimeout(()=>{P(e=>{const t=(e??0)-1;return t})},1e3)),()=>{H.current&&(window.clearTimeout(H.current),H.current=null)}),[C]),a.useEffect(()=>{if(null!==k&&k>0&&"question"===(null==A?void 0:A.phase)){const e=window.setTimeout(()=>{R(e=>{const t=(e??0)-1;return t})},1e3);return()=>window.clearTimeout(e)}},[k,null==A?void 0:A.phase]);const se=(null==A?void 0:A.phase)||ee,re=(null==Q?void 0:Q.status)||te;a.useEffect(()=>{(async()=>{if("finished"===se&&(null==Z?void 0:Z.uid)&&(null==V?void 0:V.id)){const e=_[Z.uid]||[];M[Z.uid],e.filter(e=>e.isCorrect).length}})()},[se,null==Z?void 0:Z.uid,null==V?void 0:V.id,_,M]);const ae=a.useMemo(()=>((null==B?void 0:B.questions)||[]).map(e=>{let t=[],s=0;return e.answers&&Array.isArray(e.answers)?(t=e.answers.map(e=>e.text),s=e.answers.findIndex(e=>e.isCorrect),-1===s&&(s=0)):e.options&&Array.isArray(e.options)&&(t=e.options,s=0),{id:e.id,title:e.text||e.title||"No question text",options:t,correct:s,type:e.type,points:e.points,explanation:`Correct answer: ${t[s]||"N/A"}`}}),[null==B?void 0:B.questions]),ie=(null==B?void 0:B.currentQuestionIndex)||0,le=ae[ie]||{id:"error",title:"No question available",options:["Please wait..."],correct:0,explanation:"Question loading..."},ne=(ae.length,"development"===(null==W?void 0:W.NODE_ENV));a.useEffect(()=>{if(!(g||w||K<=0))return G.current=window.setTimeout(()=>{X(e=>e-1)},1e3),()=>{G.current&&(window.clearTimeout(G.current),G.current=null)}},[K,g,w]),a.useEffect(()=>{K<=0&&!g&&null!==x&&oe()},[K,g,x]),a.useEffect(()=>{if(!(null===S||S<=0))return $.current=window.setTimeout(()=>{q(e=>null!==e?e-1:null)},1e3),()=>{$.current&&(window.clearTimeout($.current),$.current=null)}},[S]);const oe=async e=>{const t=void 0!==e?e:x;if(!g&&null!==t&&(j(!0),s&&(null==V?void 0:V.id)&&(null==le?void 0:le.id)&&(null==Z?void 0:Z.uid)))try{const e=Y-K,r=t===le.correct,a=r?Math.max(10,Math.floor(100-2*e)):0;L(e=>({...e,[Z.uid]:(e[Z.uid]||0)+a})),F(s=>({...s,[Z.uid]:{answer:t,timeSpent:e,isCorrect:r,points:a}})),U(s=>({...s,[Z.uid]:[...s[Z.uid]||[],{questionId:le.id,selectedAnswer:t,isCorrect:r,timeSpent:e,points:a}]})),await s.submitAnswer(V.id,le.id,t,e),setTimeout(()=>{I({isCorrect:r,correctAnswer:le.correct,selectedAnswer:t,points:a,explanation:le.explanation||""}),N(!0)},1e3)}catch(r){j(!1)}},de=a.useMemo(()=>Math.max(0,Math.min(100,Math.round(K/Y*100))),[K,Y]),ce=2*Math.PI*16,me=ce-de/100*ce;return i.jsx("div",{className:"min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-blue-100 p-2 sm:p-4 lg:p-6",children:i.jsxs("div",{className:"max-w-4xl mx-auto",children:["starting"===re&&null!==C&&C>0&&i.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-8 text-center mb-6",children:[i.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-4",children:"Game Starting Soon!"}),i.jsx("div",{className:"text-6xl font-bold text-purple-600 mb-4",children:C}),i.jsx("p",{className:"text-gray-600",children:"Get ready to answer questions!"})]}),"results"===se&&D&&i.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-6 mb-6",children:[i.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-4 text-center",children:"Question Results"}),i.jsx("div",{className:"mb-6 p-4 bg-blue-50 rounded-xl border border-blue-200",children:i.jsxs("div",{className:"text-center",children:[i.jsx("div",{className:"text-2xl font-bold mb-2 "+(D.isCorrect?"text-green-600":"text-red-600"),children:D.isCorrect?"✅ Correct!":"❌ Wrong!"}),i.jsxs("div",{className:"text-lg text-gray-700 mb-2",children:["You earned ",i.jsxs("span",{className:"font-bold text-blue-600",children:["+",D.points]})," points"]}),i.jsxs("div",{className:"text-sm text-gray-600",children:["Correct Answer: ",i.jsx("span",{className:"font-semibold",children:(null==(o=le.options)?void 0:o[D.correctAnswer])||"N/A"})]}),D.explanation&&i.jsx("p",{className:"text-xs text-gray-500 mt-2",children:D.explanation})]})}),i.jsxs("div",{className:"mb-4",children:[i.jsx("h4",{className:"font-semibold text-gray-700 mb-3 text-center",children:"Current Standings"}),i.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:Object.entries(M).sort(([,e],[,t])=>t-e).slice(0,5).map(([e,t],s)=>{var r,a;const l=null==(r=null==V?void 0:V.players)?void 0:r.find(t=>t.id===e),n=e===(null==Z?void 0:Z.uid),o=s+1,d=1===o?"👑":2===o?"🥈":3===o?"🥉":"🏅",c=O[e];return i.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg "+(n?"bg-blue-100 border border-blue-300":"bg-gray-50"),children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("span",{className:"text-lg",children:d}),i.jsxs("div",{children:[i.jsxs("div",{className:"font-medium text-sm "+(n?"text-blue-700":"text-gray-800"),children:["#",o," ",(null==l?void 0:l.username)||(null==l?void 0:l.name)||"Player",n&&i.jsx("span",{className:"ml-1 text-xs",children:"(You)"})]}),i.jsxs("div",{className:"text-xs text-gray-500",children:[(null==(a=_[e])?void 0:a.filter(e=>e.isCorrect).length)||0," correct",c&&i.jsxs("span",{className:"ml-2 "+(c.isCorrect?"text-green-600":"text-red-600"),children:[c.isCorrect?"✓":"✗"," +",c.points]})]})]})]}),i.jsxs("div",{className:"text-right "+(n?"text-blue-700":"text-gray-700"),children:[i.jsx("div",{className:"font-bold text-sm",children:t}),i.jsx("div",{className:"text-xs text-gray-500",children:"pts"})]})]},e)})})]}),null!==S&&i.jsx("div",{className:"mt-4 text-center",children:i.jsxs("p",{className:"text-gray-600",children:["Next question in: ",i.jsxs("span",{className:"font-bold text-blue-600",children:[S,"s"]})]})})]}),"finished"===se&&i.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-8 text-center mb-6",children:[i.jsx("h2",{className:"text-3xl font-bold text-gray-800 mb-6",children:"🏆 Game Finished!"}),i.jsxs("div",{className:"max-w-2xl mx-auto mb-6",children:[i.jsx("h3",{className:"text-xl font-semibold text-gray-700 mb-4",children:"Final Leaderboard"}),i.jsx("div",{className:"space-y-3",children:Object.entries(M).sort(([,e],[,t])=>t-e).map(([e,t],s)=>{var r;const a=null==(r=null==V?void 0:V.players)?void 0:r.find(t=>t.id===e),l=e===(null==Z?void 0:Z.uid),n=s+1,o=1===n?"🥇":2===n?"🥈":3===n?"🥉":"🏅",d=(_[e]||[]).filter(e=>e.isCorrect).length,c=ae.length;return i.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl border-2 "+(l?"border-blue-500 bg-blue-50":"border-gray-200 bg-gray-50"),children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsx("span",{className:"text-2xl",children:o}),i.jsxs("div",{className:"text-left",children:[i.jsxs("div",{className:"font-semibold "+(l?"text-blue-700":"text-gray-800"),children:["#",n," ",(null==a?void 0:a.username)||(null==a?void 0:a.name)||"Player",l&&i.jsx("span",{className:"ml-2 text-sm",children:"(You)"})]}),i.jsxs("div",{className:"text-sm text-gray-600",children:[d,"/",c," correct • Accuracy: ",c>0?Math.round(d/c*100):0,"%"]})]})]}),i.jsxs("div",{className:"text-right "+(l?"text-blue-700":"text-gray-700"),children:[i.jsx("div",{className:"text-xl font-bold",children:t}),i.jsx("div",{className:"text-sm text-gray-500",children:"points"})]})]},e)})})]}),i.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 max-w-lg mx-auto",children:[i.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[i.jsx("div",{className:"text-2xl font-bold text-gray-800",children:ae.length}),i.jsx("div",{className:"text-sm text-gray-600",children:"Questions"})]}),i.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[i.jsx("div",{className:"text-2xl font-bold text-gray-800",children:Object.keys(M).length}),i.jsx("div",{className:"text-sm text-gray-600",children:"Players"})]}),i.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[i.jsx("div",{className:"text-2xl font-bold text-gray-800",children:(null==(d=_[(null==Z?void 0:Z.uid)||""])?void 0:d.filter(e=>e.isCorrect).length)||0}),i.jsx("div",{className:"text-sm text-gray-600",children:"Your Correct"})]})]}),i.jsx("p",{className:"text-lg text-gray-600 mb-4",children:"Thanks for playing!"}),i.jsxs("div",{className:"flex gap-3 justify-center",children:[i.jsx("button",{onClick:()=>window.location.href="/multiplayer",className:"bg-gradient-to-r from-purple-500 to-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-purple-600 hover:to-blue-700 transform hover:scale-105 transition-all duration-200 shadow-lg",children:"Play Again"}),i.jsx("button",{onClick:()=>window.location.href="/profile",className:"bg-gradient-to-r from-gray-500 to-gray-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-gray-600 hover:to-gray-700 transform hover:scale-105 transition-all duration-200 shadow-lg",children:"View Profile"})]})]}),"playing"===re&&"finished"!==se&&null===C&&i.jsxs(i.Fragment,{children:[i.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-4 sm:mb-6",children:[i.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4",children:[i.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4",children:[i.jsxs("div",{className:"bg-gradient-to-r from-purple-500 to-blue-600 text-white px-3 sm:px-4 py-2 rounded-xl font-bold text-sm sm:text-base text-center",children:["Question ",ie+1," of ",ae.length]}),i.jsxs("div",{className:"flex items-center gap-2 text-gray-600 justify-center sm:justify-start",children:[i.jsx(l,{size:18}),i.jsxs("span",{className:"text-sm sm:text-base",children:[(null==(c=null==V?void 0:V.players)?void 0:c.length)||0," players"]})]})]}),i.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-2 sm:gap-4",children:[g&&i.jsxs("div",{className:"flex items-center gap-2 bg-green-100 text-green-700 px-3 py-2 rounded-xl font-medium text-sm",children:[i.jsx(p,{size:16}),i.jsx("span",{children:"Answer Submitted!"})]}),i.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[i.jsxs("div",{className:"flex items-center gap-2 px-3 sm:px-4 py-2 rounded-xl font-bold text-sm sm:text-base "+(K<=5?"bg-red-100 text-red-700":"bg-blue-100 text-blue-700"),children:[i.jsx(n,{size:16}),i.jsxs("span",{children:[K,"s"]})]}),i.jsxs("div",{className:"relative w-12 h-12 sm:w-16 sm:h-16",children:[i.jsxs("svg",{className:"w-12 h-12 sm:w-16 sm:h-16 transform -rotate-90",viewBox:"0 0 36 36",children:[i.jsx("circle",{cx:"18",cy:"18",r:"16",fill:"none",stroke:"#e5e7eb",strokeWidth:"3"}),i.jsx("circle",{cx:"18",cy:"18",r:"16",fill:"none",stroke:K<=5?"#ef4444":"#3b82f6",strokeWidth:"3",strokeLinecap:"round",strokeDasharray:ce,strokeDashoffset:me,className:"transition-all duration-1000"})]}),i.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:i.jsxs("span",{className:"text-xs font-bold "+(K<=5?"text-red-600":"text-blue-600"),children:[de,"%"]})})]})]})]})]}),K<=10&&!g&&i.jsx("div",{className:"bg-orange-100 border-l-4 border-orange-500 p-4 rounded-r-lg mb-4",children:i.jsxs("div",{className:"flex items-center gap-2 text-orange-700",children:[i.jsx(E,{size:18}),i.jsxs("span",{className:"font-medium",children:["Hurry up! Only ",K," seconds left!"]})]})})]}),i.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8",children:[ne&&i.jsxs("div",{className:"mb-4 p-3 bg-yellow-100 border border-yellow-300 rounded text-sm",children:[i.jsx("strong",{children:"🐛 Question Debug:"}),i.jsx("br",{}),"Question ID: ",(null==le?void 0:le.id)||"None",i.jsx("br",{}),"Question Title: ",(null==le?void 0:le.title)||"None",i.jsx("br",{}),"Options Count: ",(null==(m=null==le?void 0:le.options)?void 0:m.length)||0,i.jsx("br",{}),"Question Index: ",ie,"/",ae.length,i.jsx("br",{}),i.jsx("strong",{children:"Data Source:"})," ",(null==(u=null==B?void 0:B.questions)?void 0:u.length)?"GameData (Firestore)":"No Data",i.jsx("br",{}),i.jsx("strong",{children:"Real Questions Available:"})," ",ae.length]}),i.jsxs("div",{className:"text-center mb-6 sm:mb-8",children:[i.jsx("h2",{className:"text-lg sm:text-xl lg:text-2xl font-bold text-gray-800 mb-4",children:le.title||"No question available"}),i.jsx("div",{className:"w-12 sm:w-16 h-1 bg-gradient-to-r from-purple-500 to-blue-600 mx-auto rounded-full"})]}),(!le.options||0===le.options.length)&&i.jsxs("div",{className:"text-center p-8 bg-gray-50 rounded-xl",children:[i.jsx("p",{className:"text-gray-600",children:"Waiting for question options to load..."}),i.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:["Questions available: ",ae.length," | Current index: ",ie]})]}),le.options&&le.options.length>0?i.jsx("div",{className:"grid gap-3 sm:gap-4 mb-6 sm:mb-8",children:le.options.map((e,t)=>{const s=x===t;return i.jsx("button",{onClick:()=>{var e;g||(e=t,g||h(e),setTimeout(()=>oe(t),100))},className:`group relative px-4 sm:px-6 py-3 sm:py-4 rounded-2xl text-left transition-all duration-200 transform hover:scale-105 ${s?"border-2 border-blue-500 bg-gradient-to-r from-blue-50 to-indigo-50 shadow-lg":"border-2 border-gray-200 bg-white hover:border-gray-300 hover:shadow-md"} ${g?"opacity-60 cursor-not-allowed transform-none":""}`,disabled:g,children:i.jsxs("div",{className:"flex items-center gap-3 sm:gap-4",children:[i.jsx("div",{className:"w-8 h-8 sm:w-10 sm:h-10 rounded-xl flex items-center justify-center font-bold text-xs sm:text-sm "+(s?"bg-blue-500 text-white":"bg-gray-100 text-gray-600 group-hover:bg-gray-200"),children:["A","B","C","D"][t]||t+1}),i.jsx("span",{className:"font-medium text-gray-800 text-sm sm:text-base",children:e})]})},t)})}):i.jsx("div",{className:"bg-red-100 p-4 rounded-lg",children:i.jsx("p",{className:"text-red-700",children:"❌ No options available for this question"})}),i.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[i.jsx("div",{className:"text-sm text-gray-500 text-center sm:text-left",children:g?"Answer submitted! Waiting for results...":null!==x?"Answer selected - Click Submit when ready":"Choose your answer first"}),g&&i.jsxs("div",{className:"flex items-center gap-2 bg-green-100 text-green-700 px-4 py-2 rounded-xl font-medium",children:[i.jsx(p,{size:16}),i.jsx("span",{children:"Submitted!"})]})]})]}),w&&D&&i.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:i.jsx("div",{className:"bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6 transform animate-in fade-in zoom-in-95 duration-300",children:i.jsxs("div",{className:"text-center mb-6",children:[i.jsx("div",{className:"w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-4 "+(D.isCorrect?"bg-green-100 text-green-600":"bg-red-100 text-red-600"),children:D.isCorrect?i.jsx(p,{size:40}):i.jsx(E,{size:40})}),i.jsx("h3",{className:"text-2xl font-bold mb-2 "+(D.isCorrect?"text-green-600":"text-red-600"),children:D.isCorrect?"🎉 Correct!":"❌ Incorrect"}),i.jsxs("div",{className:"text-3xl font-bold text-blue-600 mb-4",children:["+",D.points," points"]}),i.jsx("p",{className:"text-gray-600 mb-4",children:D.explanation}),null!==S&&i.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-xl p-4",children:i.jsxs("div",{className:"flex items-center justify-center gap-2 text-blue-700",children:[i.jsx(n,{size:20}),i.jsxs("span",{className:"font-semibold",children:["Next question in ",S," seconds..."]})]})})]})})})]})]})})},K=({players:e=[],currentUserId:t="",gameStats:s={totalQuestions:0,totalTime:0,averageScore:0},onPlayAgain:a,onBackToLobby:o,onLeaveRoom:d})=>{const{t:c}=r(),m=e=>{switch(e){case 1:return i.jsx(_,{className:"w-6 h-6 text-yellow-500"});case 2:return i.jsx(H,{className:"w-6 h-6 text-gray-400"});case 3:return i.jsx(U,{className:"w-6 h-6 text-orange-500"});default:return i.jsxs("div",{className:"w-6 h-6 flex items-center justify-center text-gray-500 font-bold",children:["#",e]})}},u=e=>{switch(e){case 1:return"bg-gradient-to-r from-yellow-100 to-yellow-200 border-yellow-300";case 2:return"bg-gradient-to-r from-gray-100 to-gray-200 border-gray-300";case 3:return"bg-gradient-to-r from-orange-100 to-orange-200 border-orange-300";default:return"bg-gray-50 border-gray-200"}},x=e.find(e=>e.id===t),h=[...e].sort((e,t)=>t.score-e.score);return i.jsxs("div",{className:"max-w-4xl mx-auto p-4 space-y-6",children:[i.jsxs("div",{className:"text-center space-y-4",children:[i.jsxs("div",{className:"flex items-center justify-center gap-3",children:[i.jsx(_,{className:"w-8 h-8 text-yellow-500"}),i.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:c("multiplayer.game.gameOver")})]}),x&&i.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 inline-block",children:[i.jsx("div",{className:"text-lg font-semibold text-blue-900",children:c("multiplayer.yourResult")}),i.jsxs("div",{className:"flex items-center justify-center gap-6 mt-2 text-blue-800",children:[i.jsxs("div",{className:"text-center",children:[i.jsx("div",{className:"text-2xl font-bold",children:x.score}),i.jsx("div",{className:"text-sm",children:c("common.points")})]}),i.jsxs("div",{className:"text-center",children:[i.jsxs("div",{className:"text-2xl font-bold",children:["#",x.rank]}),i.jsx("div",{className:"text-sm",children:c("common.rank")})]}),i.jsxs("div",{className:"text-center",children:[i.jsxs("div",{className:"text-2xl font-bold",children:[Math.round(x.correctAnswers/x.totalAnswers*100),"%"]}),i.jsx("div",{className:"text-sm",children:c("common.accuracy")})]})]})]})]}),i.jsxs("div",{className:"bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden",children:[i.jsx("div",{className:"bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4",children:i.jsxs("h2",{className:"text-xl font-bold flex items-center gap-2",children:[i.jsx(_,{className:"w-6 h-6"}),c("multiplayer.game.finalResults")]})}),i.jsx("div",{className:"divide-y divide-gray-200",children:h.map((e,s)=>i.jsxs("div",{className:`p-4 flex items-center gap-4 ${u(s+1)} ${e.id===t?"ring-2 ring-blue-500":""}`,children:[i.jsx("div",{className:"flex items-center justify-center w-12",children:m(s+1)}),i.jsxs("div",{className:"flex-1",children:[i.jsxs("div",{className:"font-semibold text-gray-900 flex items-center gap-2",children:[e.username,e.id===t&&i.jsx("span",{className:"text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full",children:c("common.you")})]}),i.jsxs("div",{className:"text-sm text-gray-600",children:[e.correctAnswers,"/",e.totalAnswers," ",c("common.correct")," •",Math.round(e.averageTime),"s ",c("common.avgTime")]})]}),i.jsxs("div",{className:"text-right",children:[i.jsx("div",{className:"text-xl font-bold text-gray-900",children:e.score}),i.jsx("div",{className:"text-xs text-gray-500",children:c("common.points")})]}),i.jsxs("div",{className:"text-right w-16",children:[i.jsxs("div",{className:"text-lg font-semibold text-gray-700",children:[Math.round(e.correctAnswers/e.totalAnswers*100),"%"]}),i.jsx("div",{className:"text-xs text-gray-500",children:c("common.accuracy")})]})]},e.id))})]}),i.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[i.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-4 text-center",children:[i.jsx(j,{className:"w-8 h-8 text-blue-600 mx-auto mb-2"}),i.jsx("div",{className:"text-2xl font-bold text-gray-900",children:s.totalQuestions}),i.jsx("div",{className:"text-sm text-gray-600",children:c("multiplayer.totalQuestions")})]}),i.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-4 text-center",children:[i.jsx(n,{className:"w-8 h-8 text-green-600 mx-auto mb-2"}),i.jsxs("div",{className:"text-2xl font-bold text-gray-900",children:[Math.round(s.totalTime/60),"m"]}),i.jsx("div",{className:"text-sm text-gray-600",children:c("multiplayer.totalTime")})]}),i.jsxs("div",{className:"bg-white rounded-lg shadow border border-gray-200 p-4 text-center",children:[i.jsx(l,{className:"w-8 h-8 text-purple-600 mx-auto mb-2"}),i.jsx("div",{className:"text-2xl font-bold text-gray-900",children:Math.round(s.averageScore)}),i.jsx("div",{className:"text-sm text-gray-600",children:c("multiplayer.avgScore")})]})]}),i.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 justify-center",children:[a&&i.jsx("button",{onClick:a,className:"px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium",children:c("multiplayer.playAgain")}),o&&i.jsx("button",{onClick:o,className:"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium",children:c("multiplayer.backToLobby")}),d&&i.jsx("button",{onClick:d,className:"px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium",children:c("multiplayer.leaveRoom")})]})]})},X=({messages:e,onSendMessage:t,currentUserId:s,disabled:l=!1})=>{const{t:n}=r(),[o,d]=a.useState(""),c=a.useRef(null),m=a.useRef(null);a.useEffect(()=>{var e;null==(e=c.current)||e.scrollIntoView({behavior:"smooth"})},[e]);return i.jsxs("div",{className:"flex flex-col h-full bg-white border border-gray-200 rounded-lg",children:[i.jsxs("div",{className:"flex items-center gap-2 p-3 border-b border-gray-200 bg-gray-50 rounded-t-lg",children:[i.jsx(O,{className:"w-5 h-5 text-blue-600"}),i.jsx("h3",{className:"font-medium text-gray-900",children:n("multiplayer.chat.title")}),i.jsx("div",{className:"ml-auto",children:i.jsxs("span",{className:"text-xs text-gray-500",children:[e.length," ",n("common.messages")]})})]}),i.jsxs("div",{className:"flex-1 overflow-y-auto p-3 space-y-2 max-h-64",children:[0===e.length?i.jsx("div",{className:"text-center text-gray-500 text-sm py-8",children:n("multiplayer.chat.noMessages")}):e.map(e=>{return i.jsx("div",{className:"flex flex-col "+("system"===e.type?"items-center":e.userId===s?"items-end":"items-start"),children:"system"===e.type?i.jsx("div",{className:"bg-gray-100 text-gray-600 text-xs px-3 py-1 rounded-full",children:e.message}):i.jsxs("div",{className:"max-w-xs lg:max-w-md px-3 py-2 rounded-lg text-sm "+(e.userId===s?"bg-blue-600 text-white":"bg-gray-100 text-gray-900"),children:[e.userId!==s&&i.jsx("div",{className:"text-xs opacity-75 mb-1 font-medium",children:e.username}),i.jsx("div",{children:e.message}),i.jsx("div",{className:"text-xs mt-1 "+(e.userId===s?"text-blue-200":"text-gray-500"),children:(t=e.timestamp,new Intl.DateTimeFormat("vi-VN",{hour:"2-digit",minute:"2-digit"}).format(t))})]})},e.id);var t}),i.jsx("div",{ref:c})]}),i.jsxs("form",{onSubmit:e=>{var s;e.preventDefault(),o.trim()&&!l&&(t(o.trim()),d(""),null==(s=m.current)||s.focus())},className:"p-3 border-t border-gray-200",children:[i.jsxs("div",{className:"flex gap-2",children:[i.jsx("input",{ref:m,type:"text",value:o,onChange:e=>d(e.target.value),placeholder:n(l?"multiplayer.chat.disabled":"multiplayer.chat.placeholder"),className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm disabled:bg-gray-100 disabled:text-gray-500",disabled:l,maxLength:200}),i.jsx("button",{type:"submit",disabled:!o.trim()||l,className:"px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:i.jsx(F,{className:"w-4 h-4"})})]}),o.length>150&&i.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-right",children:[o.length,"/200"]})]})]})};class Z{constructor(){t(this,"events",{})}on(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}off(e,t){this.events[e]&&(this.events[e]=this.events[e].filter(e=>e!==t))}emit(e,...t){this.events[e]&&this.events[e].forEach(e=>e(...t))}}class ee extends Z{constructor(){super(...arguments),t(this,"userId",""),t(this,"username",""),t(this,"currentRoomId",null),t(this,"unsubscribeFunctions",[])}async connect(e,t){this.userId=e,this.username=t,this.emit("connected",{userId:e,username:t})}async disconnect(){this.unsubscribeFunctions.forEach(e=>e()),this.unsubscribeFunctions=[];try{if(this.currentRoomId&&this.userId){const e=y(u,"multiplayer_rooms",this.currentRoomId,"players",this.userId);await w(e,{isOnline:!1})}}catch(e){}this.emit("disconnected")}async resumeRoom(e){var t,s,r;try{const a=y(u,"multiplayer_rooms",e),i=await N(a);if(!i.exists())return null;if(!this.userId)return null;const l=y(u,"multiplayer_rooms",e,"players",this.userId);if(!(await N(l)).exists())return null;await w(l,{isOnline:!0}),this.currentRoomId=e,this.listenToRoom(e),this.listenToPlayers(e),this.listenToMessages(e);const n=i.data(),o={id:i.id,code:n.code,name:n.name,hostId:n.hostId,players:[],maxPlayers:n.maxPlayers,isPrivate:n.isPrivate,password:n.password,status:n.status,quizId:n.quizId,quiz:n.quiz,settings:n.settings,createdAt:(null==(t=n.createdAt)?void 0:t.toDate())||new Date,startedAt:null==(s=n.startedAt)?void 0:s.toDate(),finishedAt:null==(r=n.finishedAt)?void 0:r.toDate()};return this.emit("room:updated",o),"playing"===n.status&&n.gameData&&this.emit("game:start",n.gameData),{room:o}}catch(a){return null}}async setPresence(e,t){try{if(!this.userId)return;const s=y(u,"multiplayer_rooms",e,"players",this.userId);await w(s,{isOnline:t})}catch(s){}}async createRoom(e,t){var s,r,a,i,l,n;try{if(!this.userId||!this.username)throw new Error("User not connected. Please ensure you are logged in.");const d=this.generateRoomCode(),c=y(m(u,"multiplayer_rooms")),x={id:this.userId,username:this.username,isReady:!1,isHost:!0,isOnline:!0,score:0,answers:[],joinedAt:new Date},h={code:d,name:e.name||`${this.username}'s Room`,hostId:this.userId,maxPlayers:e.maxPlayers||4,isPrivate:e.isPrivate||!1,password:e.password||null,status:"waiting",quizId:(null==t?void 0:t.id)||null,quiz:t?{id:t.id,title:t.title,description:t.description,questions:t.questions||[]}:null,settings:{timeLimit:(null==(s=e.settings)?void 0:s.timeLimit)||(null==(r=e.settings)?void 0:r.timePerQuestion)||30,timePerQuestion:(null==(a=e.settings)?void 0:a.timePerQuestion)||(null==(i=e.settings)?void 0:i.timeLimit)||30,showLeaderboard:(null==(l=e.settings)?void 0:l.showLeaderboard)??!0,allowLateJoin:(null==(n=e.settings)?void 0:n.allowLateJoin)??!0},createdAt:D()};await I(c,h);const g=y(m(u,"multiplayer_rooms",c.id,"players"),this.userId);await I(g,x),this.currentRoomId=c.id,this.listenToRoom(c.id),this.listenToPlayers(c.id),this.listenToMessages(c.id);try{const e=new URL(window.location.href);e.searchParams.set("roomId",c.id),e.searchParams.set("code",d),window.history.replaceState({},"",e.toString())}catch(o){}const p={id:c.id,code:d,name:h.name,hostId:this.userId,players:[x],maxPlayers:h.maxPlayers,isPrivate:h.isPrivate,password:h.password||void 0,status:"waiting",quizId:(null==t?void 0:t.id)||void 0,quiz:h.quiz||void 0,settings:{timeLimit:h.settings.timeLimit,timePerQuestion:h.settings.timePerQuestion,showLeaderboard:h.settings.showLeaderboard,allowLateJoin:h.settings.allowLateJoin},createdAt:new Date};return this.emit("room:created",p),{room:p,player:x}}catch(d){throw d}}async joinRoom(e,t){var s;try{const a=c(m(u,"multiplayer_rooms"),x("code","==",e),h(1)),i=await g(a);if(i.empty)throw new Error("Không tìm thấy phòng với mã này");const l=i.docs[0],n=l.data();if(n.isPrivate&&!t)throw new Error("Phòng này yêu cầu mật khẩu");if(n.isPrivate&&n.password!==t)throw new Error("Mật khẩu không đúng");const o=y(u,"multiplayer_rooms",l.id,"players",this.userId);if((await N(o)).exists())throw new Error("Bạn đã tham gia phòng này rồi");if((await g(m(u,"multiplayer_rooms",l.id,"players"))).size>=n.maxPlayers)throw new Error("Phòng đã đầy");if("playing"===n.status&&!n.settings.allowLateJoin)throw new Error("Trò chơi đang diễn ra và không cho phép tham gia muộn");const d={id:this.userId,username:this.username,isReady:!1,isHost:!1,isOnline:!0,score:0,answers:[],joinedAt:new Date},p=y(m(u,"multiplayer_rooms",l.id,"players"),this.userId);await I(p,d),this.currentRoomId=l.id,this.listenToRoom(l.id),this.listenToPlayers(l.id),this.listenToMessages(l.id),await this.sendSystemMessage(l.id,`${this.username} đã tham gia phòng`);const b={id:l.id,code:n.code,name:n.name,hostId:n.hostId,players:[d],maxPlayers:n.maxPlayers,isPrivate:n.isPrivate,password:n.password,status:n.status,quizId:n.quizId,quiz:n.quiz,settings:n.settings,createdAt:(null==(s=n.createdAt)?void 0:s.toDate())||new Date};try{const e=new URL(window.location.href);e.searchParams.set("roomId",l.id),window.history.replaceState({},"",e.toString())}catch(r){}return this.emit("room:joined",b),{room:b,player:d}}catch(a){throw a}}async leaveRoom(e){try{if(!this.userId)return;const s=y(u,"multiplayer_rooms",e,"players",this.userId);await S(s),await this.sendSystemMessage(e,`${this.username} left the room`),this.unsubscribeFunctions.forEach(e=>e()),this.unsubscribeFunctions=[],this.currentRoomId=null,this.emit("room:left",e);try{const e=new URL(window.location.href);e.searchParams.delete("roomId"),e.searchParams.delete("code"),window.history.replaceState({},"",e.toString())}catch(t){}}catch(s){throw s}}async startGame(e){try{const t=y(u,"multiplayer_rooms",e);if(!(await N(t)).exists())throw new Error("Room not found");const s=new Date(Date.now()+5e3);await w(t,{status:"starting",gameStartAt:s}),setTimeout(()=>{this.actuallyStartGame(e).catch(console.error)},5e3)}catch(t){throw t}}async actuallyStartGame(e){var t,s;try{const a=y(u,"multiplayer_rooms",e),i=await N(a);if(!i.exists())throw new Error("Room not found");const l=i.data();let n=[];if(l.quiz&&Array.isArray(l.quiz.questions)&&l.quiz.questions.length>0)n=l.quiz.questions;else if(l.quizId)try{const e=y(u,"quizzes",String(l.quizId)),t=await N(e);if(t.exists()){const e=t.data();Array.isArray(e.questions)&&e.questions.length>0&&(n=e.questions)}}catch(r){}if(!n||0===n.length)throw new Error("No quiz questions available. Please select a valid quiz before starting the game.");const o=(null==(t=l.settings)?void 0:t.timePerQuestion)||(null==(s=l.settings)?void 0:s.timeLimit)||30,d={currentQuestionIndex:0,questions:n,phase:"question",timePerQuestion:o,questionEndAt:new Date(Date.now()+1e3*o),startTime:new Date,results:{}};await w(a,{status:"playing",startedAt:D(),gameData:d,"settings.timePerQuestion":o});const c={...d,timePerQuestion:o,total:n.length,index:d.currentQuestionIndex+1,currentQuestion:n[0]};this.emit("game:start",c)}catch(a){throw a}}async submitAnswer(e,t,s,r){try{const a=y(u,"multiplayer_rooms",e,"players",this.userId),i=await N(a);if(!i.exists())return;const l=i.data(),n={questionId:t,selectedAnswer:s,isCorrect:!1,timeSpent:r,points:0,timestamp:new Date},o=[...l.answers||[],n];await w(a,{answers:o}),this.emit("answer:submitted",{questionId:t,answer:s,timeSpent:r}),this.checkAndAdvanceQuestion(e,t)}catch(a){throw a}}async checkAndAdvanceQuestion(e,t){try{const s=(await g(m(u,"multiplayer_rooms",e,"players"))).docs.map(e=>e.data());if(s.every(e=>{var s;return null==(s=e.answers)?void 0:s.some(e=>e.questionId===t)})&&s.length>0){const t=y(u,"multiplayer_rooms",e);await w(t,{"gameData.phase":"results","gameData.nextQuestionAt":new Date(Date.now()+5e3),"gameData.showingResults":!0}),setTimeout(()=>{this.advanceToNextQuestion(e).catch(console.error)},5e3)}}catch(s){}}async advanceToNextQuestion(e){var t,s,r,a,i;try{const l=y(u,"multiplayer_rooms",e),n=await N(l);if(!n.exists())return;const o=n.data(),d=(null==(t=o.gameData)?void 0:t.questions)||[],c=((null==(s=o.gameData)?void 0:s.currentQuestionIndex)||0)+1,m=(null==(r=o.settings)?void 0:r.timePerQuestion)||(null==(a=o.gameData)?void 0:a.timePerQuestion)||30;if(c>=d.length)return await w(l,{status:"finished",finishedAt:D(),"gameData.phase":"finished","gameData.endTime":new Date,"gameData.showingResults":!1,"gameData.nextQuestionAt":null}),void this.emit("game:finish",(null==(i=o.gameData)?void 0:i.results)||{});await w(l,{"gameData.currentQuestionIndex":c,"gameData.phase":"question","gameData.questionEndAt":new Date(Date.now()+1e3*m),"gameData.showingResults":!1,"gameData.nextQuestionAt":null,"gameData.lastUpdated":new Date});const x=d[c];this.emit("game:next-question",{currentQuestionIndex:c,questions:d,timePerQuestion:m,total:d.length,index:c+1,currentQuestion:x})}catch(l){throw l}}async sendChatMessage(e,t){try{const s={userId:this.userId,username:this.username,message:t.trim(),timestamp:D(),type:"user"};await q(m(u,"multiplayer_rooms",e,"messages"),s)}catch(s){throw s}}async sendSystemMessage(e,t){try{const s={userId:"system",username:"System",message:t,timestamp:D(),type:"system"};await q(m(u,"multiplayer_rooms",e,"messages"),s)}catch(s){}}async updatePlayerStatus(e,t){try{const s=y(u,"multiplayer_rooms",e,"players",this.userId);await w(s,{isReady:t}),this.emit("player:status_updated",{isReady:t})}catch(s){throw s}}async kickPlayer(e,t){try{const s=y(u,"multiplayer_rooms",e,"players",t);await S(s),this.emit("player:kicked",t)}catch(s){throw s}}async updateRoomSettings(e,t){try{const s=y(u,"multiplayer_rooms",e);await w(s,{[`settings.${Object.keys(t)[0]}`]:Object.values(t)[0]}),this.emit("room:settings_updated",t)}catch(s){throw s}}listenToRoom(e){const t=y(u,"multiplayer_rooms",e),s=v(t,e=>{var t,s,r,a,i,l,n,o,d;if(e.exists()){const c=e.data(),m={id:e.id,code:c.code,name:c.name,hostId:c.hostId,players:[],maxPlayers:c.maxPlayers,isPrivate:c.isPrivate,password:c.password,status:c.status,quizId:c.quizId,quiz:c.quiz,settings:c.settings,createdAt:(null==(t=c.createdAt)?void 0:t.toDate())||new Date,startedAt:null==(s=c.startedAt)?void 0:s.toDate(),finishedAt:null==(r=c.finishedAt)?void 0:r.toDate()};if(this.emit("room:updated",m),c.gameData){const e={...c.gameData,timePerQuestion:(null==(a=c.settings)?void 0:a.timePerQuestion)||30,total:(null==(i=c.gameData.questions)?void 0:i.length)||0,index:(c.gameData.currentQuestionIndex||0)+1,currentQuestion:null==(l=c.gameData.questions)?void 0:l[c.gameData.currentQuestionIndex||0]};this.emit("game:data_updated",e)}if("playing"===c.status&&c.gameData){const e={...c.gameData,timePerQuestion:(null==(n=c.settings)?void 0:n.timePerQuestion)||30,total:(null==(o=c.gameData.questions)?void 0:o.length)||0,index:(c.gameData.currentQuestionIndex||0)+1,currentQuestion:null==(d=c.gameData.questions)?void 0:d[c.gameData.currentQuestionIndex||0]};this.emit("game:start",e)}}});this.unsubscribeFunctions.push(s)}listenToPlayers(e){const t=m(u,"multiplayer_rooms",e,"players"),s=c(t,C("joinedAt","asc")),r=v(s,e=>{const t=[];e.forEach(e=>{var s;const r=e.data();t.push({id:e.id,username:r.username,isReady:r.isReady||!1,isHost:r.isHost||!1,isOnline:r.isOnline||!0,score:r.score||0,answers:r.answers||[],joinedAt:(null==(s=r.joinedAt)?void 0:s.toDate())||new Date})}),this.emit("players:updated",t)});this.unsubscribeFunctions.push(r)}listenToMessages(e){const t=m(u,"multiplayer_rooms",e,"messages"),s=c(t,C("timestamp","asc")),r=v(s,e=>{const t=[];e.forEach(e=>{var s;const r=e.data();t.push({id:e.id,userId:r.userId,username:r.username,message:r.message,timestamp:(null==(s=r.timestamp)?void 0:s.toDate())||new Date,type:r.type})}),this.emit("messages:updated",t)});this.unsubscribeFunctions.push(r)}generateRoomCode(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let t="";for(let s=0;s<6;s++)t+=e.charAt(Math.floor(36*Math.random()));return t}}let te=null;const se=({selectedQuiz:e,currentUserId:t,currentUserName:s,onBackToQuizSelection:n,onQuizComplete:o,initialRoomId:d})=>{var c;const{t:m}=r(),[u,x]=a.useState({currentState:"mode-selection",isConnecting:!1,isConnected:!1}),[h,g]=a.useState(null),[p,b]=a.useState([]),[y,f]=a.useState("disconnected"),[v,j]=a.useState(null),[w,N]=a.useState(void 0),[D,I]=a.useState(!1),[S,q]=a.useState(!1);a.useEffect(()=>{const e=(te||(te=new ee),te);g(e);return(async()=>{try{f("connecting"),await e.connect(t,s),f("connected"),x(e=>({...e,isConnected:!0})),e.on("room:updated",C),e.on("players:updated",z),e.on("messages:updated",L),e.on("game:start",k),e.on("game:next-question",R),e.on("game:finish",A),e.on("connection:lost",_),e.on("connection:restored",U)}catch(r){f("error"),P.error(m("multiplayer.errors.connectionFailed"))}})(),()=>{e.disconnect()}},[t,s,m]),a.useEffect(()=>{var e;const t=d||u.roomId||(null==(e=u.roomData)?void 0:e.id);t&&h&&"connected"===y&&(h.setPresence(t,!0).catch(()=>{}),h.resumeRoom(t).catch(()=>{}),x(e=>({...e,currentState:"lobby",roomId:t})))},[h,y]);const C=a.useCallback(e=>{x(t=>({...t,roomData:e}));try{const t=(null==e?void 0:e.players)||[],s=t.length,r=t.filter(e=>e.isReady).length;s>=2&&r===s&&"lobby"===u.currentState?null===v&&j(5):null!==v&&j(null)}catch(t){}},[u.currentState,v]);a.useEffect(()=>{if(null===v)return;if(v<=0)return h&&u.roomId&&h.startGame(u.roomId).then(()=>{}).catch(e=>{P.error("Failed to start game")}),void j(null);const e=setTimeout(()=>{j(e=>null!==e?e-1:null)},1e3);return()=>clearTimeout(e)},[v,h,u.roomId]);const k=a.useCallback(e=>{x(t=>({...t,currentState:"game",gameData:e})),P.success(m("multiplayer.success.gameStarted"))},[m]),R=a.useCallback(e=>{x(t=>({...t,gameData:e})),P.info(`Question ${e.index}/${e.total}`)},[]),A=a.useCallback(e=>{x(t=>({...t,currentState:"results",results:e})),o(e)},[o]),z=a.useCallback(e=>{x(t=>({...t,roomData:t.roomData?{...t.roomData,players:e}:void 0}))},[]),L=a.useCallback(e=>{b(e)},[]),_=a.useCallback(()=>{f("disconnected"),P.warning(m("multiplayer.errors.connectionLost"))},[m]),U=a.useCallback(()=>{f("connected"),P.success(m("multiplayer.success.connectionRestored"))},[m]),O=e=>{x("create"===e?e=>({...e,currentState:"create-room"}):e=>({...e,currentState:"join-room"}))},F=()=>{x(e=>({...e,currentState:"mode-selection",roomId:void 0,roomData:void 0,gameData:void 0,results:void 0}))},G=(e,t)=>{x(s=>({...s,currentState:"lobby",roomId:e,roomData:t})),P.success(m("multiplayer.success.roomCreated"))},$=(e,t)=>{x(s=>({...s,currentState:"lobby",roomId:e,roomData:t})),P.success(m("multiplayer.success.joinedRoom"))},H=()=>{h&&u.roomId&&h.leaveRoom(u.roomId),x(e=>({...e,currentState:"mode-selection",roomId:void 0,roomData:void 0,gameData:void 0,results:void 0})),P.info(m("multiplayer.success.leftRoom"))},W=e=>{h&&u.roomId&&h.sendChatMessage(u.roomId,e).then(()=>{}).catch(e=>{})};return i.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900",children:[i.jsx("div",{className:"bg-white/10 backdrop-blur-md border-b border-white/20 p-4",children:i.jsxs("div",{className:"max-w-7xl mx-auto flex items-center justify-between",children:[i.jsxs("div",{className:"flex items-center gap-4",children:[i.jsxs("button",{onClick:n,className:"text-white hover:text-gray-200 transition-colors",children:["← ",m("common.back")]}),i.jsx("h1",{className:"text-xl font-bold text-white",children:m("multiplayer.title")})]}),i.jsxs("div",{className:"flex items-center gap-4",children:[(()=>{const e={disconnected:{icon:T,color:"text-red-500",text:m("multiplayer.errors.connectionLost")},connecting:{icon:Q,color:"text-yellow-500",text:m("multiplayer.errors.reconnecting")},connected:{icon:Q,color:"text-green-500",text:m("multiplayer.success.connectionRestored")},error:{icon:E,color:"text-red-500",text:m("multiplayer.errors.connectionFailed")}}[y],t=e.icon;return i.jsxs("div",{className:`flex items-center gap-2 ${e.color} text-sm`,children:[i.jsx(t,{size:16}),i.jsx("span",{children:e.text})]})})(),u.roomData&&i.jsxs("div",{className:"flex items-center gap-2 text-white",children:[i.jsx(l,{size:16}),i.jsxs("span",{children:[(null==(c=u.roomData.players)?void 0:c.length)||0,"/",u.roomData.maxPlayers||10]})]})]})]})}),i.jsx("div",{className:"flex-1",children:(()=>{switch(u.currentState){case"mode-selection":return i.jsx(M,{isOpen:!0,onClose:n,onSelectSinglePlayer:n,onSelectMultiplayer:O,connectionStatus:y});case"create-room":return i.jsx(J,{isOpen:!0,onClose:F,onCreateRoom:async t=>{try{if(I(!0),!h||"connected"!==y)return void P.info(m("multiplayer.errors.reconnecting"));const s=await h.createRoom(t,e);s&&G(s.room.id,s.room)}catch(s){const e=s.message||m("multiplayer.errors.createRoomFailed");P.error(e)}finally{I(!1)}},onRoomCreated:G,selectedQuiz:e,currentUserId:t,currentUserName:s,multiplayerService:h,loading:D||"connected"!==y});case"join-room":return i.jsx(B,{isOpen:!0,onClose:()=>{N(void 0),F()},onJoinRoom:async(e,t)=>{try{if(N(void 0),q(!0),!h||"connected"!==y)return void P.info(m("multiplayer.errors.reconnecting"));const s=await h.joinRoom(e,t);s&&$(s.room.id,s.room)}catch(s){const e=s.message||m("multiplayer.errors.joinRoomFailed");N(e),P.error(e)}finally{q(!1)}},onRoomJoined:$,loading:S||"connected"!==y,error:w,currentUserId:t,currentUserName:s,multiplayerService:h});case"lobby":return i.jsxs("div",{className:"flex h-screen",children:[i.jsxs("div",{className:"flex-1",children:[i.jsx(V,{roomData:u.roomData,currentUserId:t,onLeaveRoom:H,multiplayerService:h}),null!==v&&i.jsxs("div",{className:"m-4 p-3 bg-blue-50 border border-blue-200 rounded text-blue-700 inline-block",children:[m("common.start"),": ",v,"s"]})]}),i.jsx("div",{className:"w-80 border-l border-gray-200",children:i.jsx(X,{messages:p,onSendMessage:W,currentUserId:t})})]});case"game":return i.jsxs("div",{className:"flex h-screen",children:[i.jsxs("div",{className:"flex-1",children:[!1,i.jsx(Y,{gameData:u.gameData,roomData:u.roomData,currentUserId:t,currentUserName:s,multiplayerService:h})]}),i.jsx("div",{className:"w-80 border-l border-gray-200",children:i.jsx(X,{messages:p,onSendMessage:W,currentUserId:t})})]});case"results":return i.jsx(K,{results:u.results,roomData:u.roomData,onPlayAgain:F,onBackToMenu:n});default:return null}})()})]})},re=()=>{const e=k(),t=R(),s=e.state,r=new URLSearchParams(e.search).get("roomId")||void 0,{user:l}=b(e=>e.auth);return a.useEffect(()=>{if(!l)return void t("/login");const e=null==s?void 0:s.selectedQuiz;e?e.questions&&0!==e.questions.length||t("/quizzes",{state:{error:"Selected quiz has no questions. Please choose a different quiz."}}):t("/quizzes",{state:{error:"Please select a quiz before starting multiplayer game"}})},[l,null==s?void 0:s.selectedQuiz,t]),l&&(null==s?void 0:s.selectedQuiz)?i.jsx("div",{className:"min-h-screen bg-gray-50",children:i.jsx(se,{selectedQuiz:s.selectedQuiz,currentUserId:l.uid,currentUserName:l.displayName||l.email||"User",onBackToQuizSelection:()=>t("/quizzes"),onQuizComplete:()=>t("/leaderboard"),initialRoomId:r})}):i.jsx("div",{className:"min-h-screen flex items-center justify-center",children:i.jsxs("div",{className:"text-center",children:[i.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),i.jsx("p",{className:"mt-4 text-gray-600",children:"Loading..."})]})})};export{re as default};
