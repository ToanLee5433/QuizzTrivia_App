# ğŸ“¸ HÆ°á»›ng dáº«n Resize Images Extension

## âœ… Extension Ä‘Ã£ cÃ i Ä‘áº·t

**Resize Images** tá»« Firebase Extensions Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t vÃ  hoáº¡t Ä‘á»™ng tá»± Ä‘á»™ng.

---

## ğŸ¯ CÃ¡ch hoáº¡t Ä‘á»™ng

### 1. **Upload Flow**:
```
User upload áº£nh
   â†“
Frontend compress (30-70%)
   â†“
Upload lÃªn Storage/images/{folder}/
   â†“
Extension phÃ¡t hiá»‡n file má»›i
   â†“
Tá»± Ä‘á»™ng resize thÃ nh 3 sizes
   â†“
LÆ°u vÃ o Storage/thumbnails/
   â†“
Frontend retry láº¥y thumbnail URLs
   â†“
âœ… HoÃ n táº¥t!
```

### 2. **Thumbnail Sizes**:
- **Small**: 200x200 (cho avatars, preview nhá»)
- **Medium**: 400x400 (cho cards, grid view)
- **Large**: 800x800 (cho lightbox, detail view)

### 3. **Naming Convention**:
```
Original: avatar_userId_timestamp.jpg
  â†’ Storage path: images/avatars/avatar_userId_timestamp.jpg

Thumbnails:
  â†’ thumbnails/avatar_userId_timestamp_200x200.jpg
  â†’ thumbnails/avatar_userId_timestamp_400x400.jpg
  â†’ thumbnails/avatar_userId_timestamp_800x800.jpg
```

---

## âš™ï¸ Configuration

### Extension Settings (ÄÃ£ config):
```yaml
Collection Path: images/{folder}
Thumbnail Sizes: 200x200,400x400,800x800
Thumbnail Folder: thumbnails
Image Types: jpeg, png, webp, gif, tiff
Cache-Control: public, max-age=31536000
Delete Original: false
```

### Storage Structure:
```
Storage Root
â”œâ”€â”€ images/
â”‚   â”œâ”€â”€ avatars/          # Profile pictures
â”‚   â”œâ”€â”€ covers/           # Quiz covers
â”‚   â”œâ”€â”€ quizzes/          # Question images
â”‚   â””â”€â”€ temp/             # Temporary uploads
â””â”€â”€ thumbnails/           # Auto-generated by Extension
    â”œâ”€â”€ {filename}_200x200.{ext}
    â”œâ”€â”€ {filename}_400x400.{ext}
    â””â”€â”€ {filename}_800x800.{ext}
```

---

## ğŸ”§ Code Implementation

### imageUploadService.ts

#### **Upload vá»›i Thumbnails**:
```typescript
const result = await uploadImage(
  file,
  {
    folder: 'avatars',
    generateThumbnails: true, // Enable thumbnail generation
    maxSizeKB: 2048
  },
  (progress) => {
    console.log(`Upload: ${progress.progress}%`);
  }
);

// Result includes:
result.originalUrl      // Original image URL
result.thumbnailUrls    // { small, medium, large }
result.fileName         // Unique filename
```

#### **Retry Logic**:
```typescript
const getThumbnailUrls = async (fileName: string) => {
  // Retry up to 8-10 times
  // Wait progressively: 2s, 3s, 4s, 5s...
  // Extension needs 5-30s depending on image size
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const url = await getDownloadURL(thumbnailRef);
      return url; // âœ… Success
    } catch {
      await sleep(2000 + attempt * 1000); // Progressive wait
    }
  }
};
```

### ImageUploader.tsx

#### **Component Usage**:
```tsx
<ImageUploader
  onUploadSuccess={(result) => {
    console.log('Original:', result.originalUrl);
    console.log('Small:', result.thumbnailUrls.small);
    console.log('Medium:', result.thumbnailUrls.medium);
    console.log('Large:', result.thumbnailUrls.large);
  }}
  options={{
    folder: 'avatars',
    generateThumbnails: true
  }}
  showThumbnails={true}  // Show preview of thumbnails
/>
```

---

## â±ï¸ Processing Time

| Image Size | Processing Time | Retry Attempts |
|-----------|----------------|---------------|
| < 500KB   | 3-5 seconds    | 3-5 attempts  |
| 500KB-1MB | 5-10 seconds   | 5-7 attempts  |
| 1MB-2MB   | 10-15 seconds  | 7-8 attempts  |
| 2MB-5MB   | 15-30 seconds  | 8-10 attempts |

**Note**: Extension xá»­ lÃ½ trong background, user khÃ´ng pháº£i Ä‘á»£i!

---

## ğŸ¨ Best Practices

### 1. **Compress Before Upload**:
```typescript
// Frontend compression trÆ°á»›c khi upload
const compressed = await compressImage(file, 1920, 1080, 0.85);
// Giáº£m 30-70% file size â†’ Extension xá»­ lÃ½ nhanh hÆ¡n
```

### 2. **Use Appropriate Thumbnail**:
```tsx
{/* Avatar nhá» - dÃ¹ng small */}
<img src={result.thumbnailUrls.small} className="w-12 h-12" />

{/* Card view - dÃ¹ng medium */}
<img src={result.thumbnailUrls.medium} className="w-64 h-64" />

{/* Lightbox - dÃ¹ng large hoáº·c original */}
<img src={result.thumbnailUrls.large || result.originalUrl} />
```

### 3. **Fallback to Original**:
```tsx
// Náº¿u thumbnail chÆ°a sáºµn sÃ ng, dÃ¹ng original
const imageUrl = result.thumbnailUrls.medium || result.originalUrl;
```

### 4. **Cache Aggressively**:
```typescript
// Extension set Cache-Control: max-age=31536000 (1 nÄƒm)
// Browser sáº½ cache thumbnails â†’ Load cá»±c nhanh láº§n 2+
```

---

## ğŸ› Troubleshooting

### âŒ "Object does not exist" Error

**NguyÃªn nhÃ¢n**: Extension chÆ°a ká»‹p táº¡o thumbnails

**Giáº£i phÃ¡p**:
```typescript
// Code Ä‘Ã£ cÃ³ retry logic
// Äá»£i 2-3-4-5s giá»¯a má»—i láº§n retry
// Max 8-10 attempts = 20-30 seconds
```

### âŒ Thumbnails khÃ´ng Ä‘Æ°á»£c táº¡o

**Kiá»ƒm tra**:
1. Extension cÃ³ enabled khÃ´ng?
   ```bash
   firebase ext:list
   ```

2. Storage rules cho phÃ©p Extension ghi vÃ o `thumbnails/`?
   ```javascript
   match /thumbnails/{fileName} {
     allow write: if false; // Chá»‰ Extension má»›i ghi
   }
   ```

3. Image type cÃ³ Ä‘Æ°á»£c support?
   - âœ… jpeg, png, webp, gif, tiff
   - âŒ bmp, svg, ico

### âŒ Extension xá»­ lÃ½ cháº­m

**Tá»‘i Æ°u**:
1. Compress áº£nh trÆ°á»›c khi upload
2. Resize xuá»‘ng 1920x1080 náº¿u quÃ¡ lá»›n
3. Sá»­ dá»¥ng WebP format (nháº¹ hÆ¡n JPEG 25-35%)

---

## ğŸ“Š Monitoring

### Firebase Console:
1. **Extensions** â†’ **Resize Images**
2. **View logs** Ä‘á»ƒ xem extension activity
3. Check **Function logs**:
   ```
   âœ… Successfully resized image...
   âœ… Created thumbnail: 200x200
   âœ… Created thumbnail: 400x400
   âœ… Created thumbnail: 800x800
   ```

### Storage Console:
1. **Storage** â†’ **Files**
2. Kiá»ƒm tra folder `thumbnails/`
3. Verify thumbnails Ä‘Æ°á»£c táº¡o sau upload

---

## ğŸš€ Performance Tips

### 1. **Lazy Loading**:
```tsx
<img 
  src={thumbnailUrls.medium} 
  loading="lazy"  // Browser native lazy load
  alt="Quiz cover"
/>
```

### 2. **Responsive Images**:
```tsx
<img 
  srcSet={`
    ${thumbnailUrls.small} 200w,
    ${thumbnailUrls.medium} 400w,
    ${thumbnailUrls.large} 800w
  `}
  sizes="(max-width: 400px) 200px, (max-width: 800px) 400px, 800px"
/>
```

### 3. **Preload Critical Images**:
```tsx
<link 
  rel="preload" 
  as="image" 
  href={thumbnailUrls.medium}
/>
```

---

## ğŸ‰ Benefits

### âœ… **Automatic**:
- KhÃ´ng cáº§n code backend resize
- Extension tá»± Ä‘á»™ng xá»­ lÃ½ má»i upload
- Zero maintenance

### âœ… **Performance**:
- Thumbnails nháº¹ hÆ¡n 90-95%
- Page load nhanh hÆ¡n 3-5x
- Bandwidth tiáº¿t kiá»‡m 70-90%

### âœ… **User Experience**:
- Upload fast (compressed)
- Display fast (thumbnails)
- Seamless experience

### âœ… **Cost Effective**:
- Reduce storage costs (thumbnails < original)
- Reduce bandwidth costs
- Free tier enough cho 1000+ uploads/month

---

## ğŸ“ Summary

| Feature | Status | Notes |
|---------|--------|-------|
| Extension | âœ… Installed | Auto resize on upload |
| Thumbnails | âœ… 3 sizes | 200x200, 400x400, 800x800 |
| Retry Logic | âœ… Smart | 8-10 attempts, progressive wait |
| Compression | âœ… Frontend | 30-70% reduction before upload |
| Caching | âœ… 1 year | Browser cache aggressive |
| Monitoring | âœ… Logs | Extension + Function logs |

---

## ğŸ”— Resources

- [Firebase Extensions Docs](https://firebase.google.com/docs/extensions)
- [Resize Images Extension](https://github.com/firebase/extensions/tree/master/storage-resize-images)
- [Sharp Image Processing](https://sharp.pixelplumbing.com/)
- [WebP Format Guide](https://developers.google.com/speed/webp)

---

**ğŸ’¡ TIP**: Extension hoáº¡t Ä‘á»™ng trong background nÃªn user khÃ´ng bá»‹ delay. Upload flow váº«n fast, thumbnails sáº½ sáºµn sÃ ng trong vÃ i giÃ¢y!

**ğŸ¯ READY**: Há»‡ thá»‘ng image upload Ä‘Ã£ hoÃ n chá»‰nh vÃ  production-ready! ğŸš€
