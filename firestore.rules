rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    /* ===== Helper Functions ===== */
    function signedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return signedIn() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Check if user is the owner of a resource (for metadata with createdBy field)
    function isOwner() {
      return signedIn() && resource.data.createdBy == request.auth.uid;
    }
    
    // Check if user is creator role
    function isCreator() {
      return signedIn() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'creator';
    }
    
    // Get quiz document for subcollection access checks
    function quizDoc(quizId) {
      return get(/databases/$(database)/documents/quizzes/$(quizId));
    }
    
    // Check if user has unlocked password-protected quiz
    function hasAccess(quizId) {
      return exists(/databases/$(database)/documents/quizzes/$(quizId)/access/$(request.auth.uid));
    }
    
    /* ===== Users Collection ===== */
    match /users/{userId} {
      // Allow all authenticated users to read user profiles (leaderboard, admin, etc.)
      allow read: if signedIn();
      
      // Users can write their own document; admins can write any
      allow write: if signedIn() && (request.auth.uid == userId || isAdmin());
    }
    
    /* ===== Multiplayer Rooms ===== */
    match /multiplayer_rooms/{roomId} {
      // Allow authenticated users to read any room
      allow read: if signedIn();
      
      // Allow authenticated users to create new rooms
      allow create: if signedIn();
      
      // Allow any authenticated player in the room to update room game state
      allow update: if signedIn() && 
        exists(/databases/$(database)/documents/multiplayer_rooms/$(roomId)/players/$(request.auth.uid));
      
      // Only room creator can delete (more secure than allowing any user)
      allow delete: if signedIn() && isOwner();
      
      // Players subcollection
      match /players/{playerId} {
        allow read: if signedIn();
        allow create: if signedIn() && request.auth.uid == playerId;
        allow update: if signedIn() && request.auth.uid == playerId;
        allow delete: if signedIn() &&
          exists(/databases/$(database)/documents/multiplayer_rooms/$(roomId)/players/$(request.auth.uid));
      }
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if signedIn();
        allow create: if signedIn() && (
          request.resource.data.userId == request.auth.uid ||
          request.resource.data.type == 'system'
        );
        allow update, delete: if false;
      }
      
      // Game state subcollection
      match /gameState/{stateId} {
        allow read: if signedIn();
        allow write: if signedIn() &&
          exists(/databases/$(database)/documents/multiplayer_rooms/$(roomId)/players/$(request.auth.uid));
      }
    }

    /* ===== Multiplayer Submissions (immutable) ===== */
    match /multiplayer_rooms/{roomId}/submissions/{submissionId} {
      allow read: if signedIn() &&
        exists(/databases/$(database)/documents/multiplayer_rooms/$(roomId)/players/$(request.auth.uid));
      allow create: if signedIn() &&
        request.resource.data.playerId == request.auth.uid &&
        exists(/databases/$(database)/documents/multiplayer_rooms/$(roomId)/players/$(request.auth.uid)) &&
        !exists(/databases/$(database)/documents/multiplayer_rooms/$(roomId)/submissions/$(submissionId));
      allow update, delete: if false;
    }
    
    /* ===== QUIZZES - NEW ARCHITECTURE =====
       Cấu trúc:
       - quizzes/{quizId}                 : METADATA (title, description, visibility, pwd, stats, status, ...)
       - quizzes/{quizId}/questions/{qid} : NỘI DUNG ĐỀ (câu hỏi, đáp án) - BẢO VỆ
       - quizzes/{quizId}/access/{uid}    : DẤU HIỆU đã mở khóa password
       
       Quy tắc phân quyền theo ROLE và STATUS:
       
       ┌─────────────┬──────────┬──────────┬───────────────────────┐
       │ ROLE        │ DRAFT    │ PENDING  │ APPROVED              │
       ├─────────────┼──────────┼──────────┼───────────────────────┤
       │ Admin       │ ✅ R/W   │ ✅ R/W   │ ✅ R/W                │
       │ Creator     │ ✅ Own   │ ✅ Own   │ ✅ Own (edit request) │
       │ User        │ ❌       │ ❌       │ ✅ Read (public)      │
       └─────────────┴──────────┴──────────┴───────────────────────┘
       
       METADATA ACCESS:
       - draft: Chỉ owner + admin
       - pending: Chỉ owner + admin (đang chờ duyệt)
       - approved: Tất cả user (hiển thị danh sách)
       - rejected: Chỉ owner + admin
       
       QUESTIONS ACCESS:
       - visibility = "public" + approved → Mọi user
       - visibility = "password" + approved + hasAccess(uid) → User đã unlock
       - Owner/Admin → Luôn truy cập (để quản lý)
    */
    match /quizzes/{quizId} {
      
      /* --- READ METADATA (GET/LIST) ---
         Phân quyền theo STATUS:
         - draft/pending/rejected: Chỉ owner hoặc admin
         - approved: Tất cả user đăng nhập
      */
      allow get, list: if signedIn() && (
        // Admin sees all
        isAdmin() ||
        // Owner sees their own quizzes
        resource.data.createdBy == request.auth.uid ||
        // Everyone sees approved quizzes
        resource.data.status == 'approved'
      );
      
      /* --- CREATE QUIZ ---
         Creator và Admin có thể tạo quiz.
         Mặc định status = 'draft' khi tạo.
      */
      allow create: if signedIn() && (
        isCreator() || isAdmin()
      ) && request.resource.data.status == 'draft';
      
      /* --- UPDATE QUIZ ---
         Owner: Có thể sửa quiz draft/rejected của mình
         Admin: Có thể sửa mọi quiz và thay đổi status
         Special: Mọi user có thể cập nhật stats counters
      */
      allow update: if signedIn() && (
        // Admin can update any quiz and change status
        isAdmin() ||
        // Owner can update their draft/rejected quizzes (not approved/pending)
        (resource.data.createdBy == request.auth.uid && 
         resource.data.status in ['draft', 'rejected']) ||
        // Anyone can update stats counters (views, attempts, completions)
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['stats'])
      );
      
      /* --- DELETE QUIZ ---
         Chỉ owner hoặc admin mới được xóa.
      */
      allow delete: if signedIn() && (
        resource.data.createdBy == request.auth.uid || isAdmin()
      );
      
      /* --- ACCESS SUBCOLLECTION ---
         Client ghi /access/{uid} sau khi user nhập password đúng.
         Rules kiểm tra: proofHash client gửi lên === hash trong quizzes/{quizId}.pwd.hash
      */
      match /access/{uid} {
        // CREATE: Chỉ cho phép khi:
        // - User đăng nhập đúng uid
        // - Quiz có visibility = "password"
        // - pwd.enabled = true
        // - proofHash gửi lên khớp với pwd.hash trong metadata
        allow create: if signedIn() &&
          request.auth.uid == uid &&
          quizDoc(quizId).data.visibility == "password" &&
          quizDoc(quizId).data.pwd.enabled == true &&
          request.resource.data.proofHash == quizDoc(quizId).data.pwd.hash;
        
        // READ/DELETE: User chỉ xem/xóa access của chính họ
        allow read, delete: if signedIn() && request.auth.uid == uid;
        
        // UPDATE: Không cho phép (access là immutable)
        allow update: if false;
      }
      
      /* --- QUESTIONS SUBCOLLECTION (BẢO VỆ NỘI DUNG ĐỀ) ---
         Phân quyền theo STATUS + VISIBILITY:
         
         Điều kiện đọc:
         1. Admin - luôn đọc được (để quản lý)
         2. Owner - luôn đọc được quiz của mình
         3. User thường - chỉ khi:
            - Quiz đã approved VÀ
            - (visibility = "public" HOẶC đã unlock password)
      */
      match /questions/{qid} {
        allow read: if signedIn() && (
          // Admin can read all
          isAdmin() ||
          // Owner can read their own quiz questions
          quizDoc(quizId).data.createdBy == request.auth.uid ||
          // Regular users: only approved + (public OR unlocked)
          (quizDoc(quizId).data.status == 'approved' && (
            quizDoc(quizId).data.visibility == "public" ||
            (quizDoc(quizId).data.visibility == "password" && hasAccess(quizId))
          ))
        );
        
        // WRITE: Chỉ owner hoặc admin
        allow write: if signedIn() && (
          isAdmin() ||
          quizDoc(quizId).data.createdBy == request.auth.uid
        );
      }
    }
    
    /* ===== OTHER COLLECTIONS (keep existing logic) ===== */
    
    // Reviews collection
    match /reviews/{reviewId} {
      allow read: if signedIn();
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if signedIn() && resource.data.userId == request.auth.uid;
    }
    
    // System notifications
    match /system_notifications/{notificationId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }
    
    // User favorites
    match /user_favorites/{userId} {
      allow read, write: if signedIn() && request.auth.uid == userId;
    }
    
    // User quiz activities (tracking views, attempts, etc.)
    match /userQuizActivities/{activityId} {
      allow read: if signedIn();
      allow create, update: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow delete: if signedIn() && resource.data.userId == request.auth.uid;
    }
    
    // Quiz results
    match /quizResults/{resultId} {
      allow read: if signedIn();
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if signedIn() && resource.data.userId == request.auth.uid;
    }
    
    // Edit requests
    match /editRequests/{requestId} {
      allow read: if signedIn();
      allow create: if signedIn() && request.resource.data.requestedBy == request.auth.uid;
      allow update, delete: if signedIn() && resource.data.requestedBy == request.auth.uid;
    }
    
    // Categories
    match /categories/{categoryId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    // Quiz reviews (public ratings)
    match /quizReviews/{reviewId} {
      allow read: if true;
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if signedIn() && resource.data.userId == request.auth.uid;
    }
    
    match /{path=**}/quizReviews/{reviewId} {
      allow read: if true;
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if signedIn() && resource.data.userId == request.auth.uid;
    }

    // Per-user notifications
    match /notifications/{notificationId} {
      allow read: if signedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAdmin();
      allow update, delete: if signedIn() && (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Mail collection (Trigger Email extension)
    match /mail/{mailId} {
      allow create: if true;
      allow read, update, delete: if true;
    }
    
    // System collection (for vector index, configs, etc.)
    match /system/{docId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }
    
    // Default: deny all
    match /{document=**} {
      allow read, write: if false;
    }
  }
}